<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mainloop: mainloop_bad.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>mainloop_bad.c File Reference</h1>Example for "bad" main loop.  
<a href="#_details">More...</a>
<p>
<code>#include &lt;unistd.h&gt;</code><br>
<code>#include &lt;stdlib.h&gt;</code><br>
<code>#include &lt;stdio.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include &lt;errno.h&gt;</code><br>
<code>#include &lt;sys/time.h&gt;</code><br>
<code>#include &lt;sys/socket.h&gt;</code><br>
<code>#include &lt;signal.h&gt;</code><br>
<code>#include &lt;fcntl.h&gt;</code><br>

<p>
<a href="mainloop__bad_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="structechoclient__t.html">echoclient_t</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">echo client state  <a href="structechoclient__t.html#_details">More...</a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="structchargenclient__t.html">chargenclient_t</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a0">PORT_ECHO</a>&nbsp;&nbsp;&nbsp;5005</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">tcp port to listen for echo clients  <a href="#a0"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a1">PORT_CHARGEN</a>&nbsp;&nbsp;&nbsp;5006</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">tcp port to listen for chargen clients  <a href="#a1"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a2">HEARTBEAT_INTERVAL</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">heartbeat interval (in seconds)  <a href="#a2"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a3">SLOWHEARTBEAT_INTERVAL</a>&nbsp;&nbsp;&nbsp;15</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">slow heartbeat interval (in seconds)  <a href="#a3"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a4">BUFSIZE</a>&nbsp;&nbsp;&nbsp;16</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">buffer size for echo client  <a href="#a4"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">maximum number of clients  <a href="#a5"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a6">MSG_HEARTBEAT</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a7">MSG_SLOWHEARTBEAT</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a8">MSG_MAINLOOP</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a9">MSG_ACCEPT</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a10">MSG_TOOMANY</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a11">MSG_CLOSE</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a12">MSG_READ</a>&nbsp;&nbsp;&nbsp;6</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>&nbsp;&nbsp;&nbsp;7</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a14">MSG_FULL</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a15">MSG_EMPTY</a>&nbsp;&nbsp;&nbsp;9</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a16">MIN</a>(a, b)&nbsp;&nbsp;&nbsp;((a)&lt;(b)?(a):(b))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a17">MAX</a>(a, b)&nbsp;&nbsp;&nbsp;((a)&gt;(b)?(a):(b))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a19">message</a> (int msg)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">print message describing current activity  <a href="#a19"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a20">listensocket</a> (int port)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">return tcp socket listening on port specified  <a href="#a20"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a21">setnonblock</a> (int fd)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">set a file descriptor to be nonblocking  <a href="#a21"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a22">sighandler</a> (int signo)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">signal handler  <a href="#a22"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a23">readecho</a> (<a class="el" href="structechoclient__t.html">echoclient_t</a> *client)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">read data from an echo client  <a href="#a23"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a24">writeecho</a> (<a class="el" href="structechoclient__t.html">echoclient_t</a> *client)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">write data to an echo client  <a href="#a24"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a25">writechargen</a> (<a class="el" href="structchargenclient__t.html">chargenclient_t</a> *client)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">write data to a chargen client  <a href="#a25"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a26">main</a> ()</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>char&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="mainloop__bad_8c.html#a18">chargen_buf</a> [] = "0123456789abcdefghijklmnopqrstuv"</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">characters to  <a href="#a18"></a><br><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Example for "bad" main loop. 
<p>
<dl compact><dt><b>Author:</b></dt><dd>Rico Pajarola</dd></dl>
This example tries to do everything as bad as possible without doing it just plain wrong (that's not as easy as it sounds). This is done by putting all the logic into one huge main loop, and explicitly spelling out all special cases in place.<p>
Apart from the time spent trying to find worse ways to do things, this example was completed really quick. That is, at least until I tried to add a second client and a second timer...<p>
To emphasize that this is the bad example, select() is used.
<p>
Definition in file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.<hr><h2>Define Documentation</h2>
<a class="anchor" name="a4" doxytag="mainloop_bad.c::BUFSIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BUFSIZE&nbsp;&nbsp;&nbsp;16          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
buffer size for echo client 
<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00042">42</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__glib_8c-source.html#l00498">echo_dispatch_read()</a>, <a class="el" href="mainloop__glib_8c-source.html#l00546">echo_dispatch_write()</a>, <a class="el" href="mainloop__glib_8c-source.html#l00442">echo_prepare()</a>, <a class="el" href="mainloop__good_8c-source.html#l00646">flowecho()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00379">main()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00257">readecho()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00304">writeecho()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="mainloop_bad.c::HEARTBEAT_INTERVAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HEARTBEAT_INTERVAL&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
heartbeat interval (in seconds) 
<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00036">36</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__bad_8c-source.html#l00379">main()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00139">sighandler()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="mainloop_bad.c::MAX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((a)&gt;(b)?(a):(b))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00059">59</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__good_8c-source.html#l00307">alarmhandler()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00139">sighandler()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="mainloop_bad.c::MAXCLIENTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAXCLIENTS&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
maximum number of clients 
<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00045">45</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__good_8c-source.html#l00437">addclient()</a>, <a class="el" href="mainloop__good_8c-source.html#l00418">initclients()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00379">main()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="mainloop_bad.c::MIN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MIN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((a)&lt;(b)?(a):(b))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00058">58</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__good_8c-source.html#l00307">alarmhandler()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00139">sighandler()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="mainloop_bad.c::MSG_ACCEPT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MSG_ACCEPT&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00050">50</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__glib_8c-source.html#l00347">accept_dispatch()</a>, <a class="el" href="mainloop__good_8c-source.html#l00524">acceptecho()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00379">main()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00096">message()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="mainloop_bad.c::MSG_CLOSE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MSG_CLOSE&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00052">52</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__good_8c-source.html#l00666">closeclient()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00096">message()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00257">readecho()</a>, <a class="el" href="mainloop__glib_8c-source.html#l00592">source_close()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00350">writechargen()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00304">writeecho()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="mainloop_bad.c::MSG_EMPTY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MSG_EMPTY&nbsp;&nbsp;&nbsp;9          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00056">56</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__glib_8c-source.html#l00546">echo_dispatch_write()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00096">message()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00304">writeecho()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="mainloop_bad.c::MSG_FULL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MSG_FULL&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00055">55</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__glib_8c-source.html#l00498">echo_dispatch_read()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00096">message()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00257">readecho()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="mainloop_bad.c::MSG_HEARTBEAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MSG_HEARTBEAT&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00047">47</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__glib_8c-source.html#l00281">heartbeat()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00096">message()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00139">sighandler()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="mainloop_bad.c::MSG_MAINLOOP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MSG_MAINLOOP&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00049">49</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__bad_8c-source.html#l00379">main()</a>, <a class="el" href="mainloop__good_8c-source.html#l00481">mainloop()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00096">message()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="mainloop_bad.c::MSG_READ" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MSG_READ&nbsp;&nbsp;&nbsp;6          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00053">53</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__glib_8c-source.html#l00498">echo_dispatch_read()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00096">message()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00257">readecho()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="mainloop_bad.c::MSG_SLOWHEARTBEAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MSG_SLOWHEARTBEAT&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00048">48</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__bad_8c-source.html#l00096">message()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00139">sighandler()</a>, and <a class="el" href="mainloop__glib_8c-source.html#l00293">slowheartbeat()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="mainloop_bad.c::MSG_TOOMANY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MSG_TOOMANY&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00051">51</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__good_8c-source.html#l00437">addclient()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00379">main()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00096">message()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="mainloop_bad.c::MSG_WRITE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MSG_WRITE&nbsp;&nbsp;&nbsp;7          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00054">54</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__glib_8c-source.html#l00633">chargen_dispatch()</a>, <a class="el" href="mainloop__glib_8c-source.html#l00546">echo_dispatch_write()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00096">message()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00350">writechargen()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00304">writeecho()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="mainloop_bad.c::PORT_CHARGEN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PORT_CHARGEN&nbsp;&nbsp;&nbsp;5006          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
tcp port to listen for chargen clients 
<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00033">33</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__bad_8c-source.html#l00379">main()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="mainloop_bad.c::PORT_ECHO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PORT_ECHO&nbsp;&nbsp;&nbsp;5005          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
tcp port to listen for echo clients 
<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00030">30</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__bad_8c-source.html#l00379">main()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="mainloop_bad.c::SLOWHEARTBEAT_INTERVAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SLOWHEARTBEAT_INTERVAL&nbsp;&nbsp;&nbsp;15          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
slow heartbeat interval (in seconds) 
<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00039">39</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__bad_8c-source.html#l00379">main()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00139">sighandler()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a20" doxytag="mainloop_bad.c::listensocket" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int listensocket           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>port</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
return tcp socket listening on port specified 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>port</em>&nbsp;</td><td>port number in host byte order</td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>file descriptor for listening socket</dd></dl>
The socket is set to be nonblocking 
<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00193">193</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
References <a class="el" href="mainloop__good_8c-source.html#l00406">setnonblock()</a>.
<p>
<pre class="fragment"><div>00194 {
00195     <span class="keywordtype">int</span>             serverfd;
00196     <span class="keyword">struct </span>sockaddr_in sain;
00197     <span class="keywordtype">int</span>             one;
00198 
00199     <span class="comment">/* set up tcp socket for listening */</span>
00200     sain.sin_family = AF_INET;
00201     sain.sin_port = htons(port);
00202     sain.sin_addr.s_addr = INADDR_ANY;
00203     <span class="keywordflow">if</span> ((serverfd = socket(AF_INET, SOCK_STREAM, 0)) == -1) {
00204         perror(<span class="stringliteral">"socket(AF_INET, SOCK_STREAM, 0)"</span>);
00205         exit(EXIT_FAILURE);
00206     }
00207     one = 1;
00208     <span class="keywordflow">if</span> (setsockopt
00209         (serverfd, SOL_SOCKET, SO_REUSEADDR, &amp;one,
00210          (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(one)) == -1) {
00211         perror(<span class="stringliteral">"setsockopt(SO_REUSEADDR)"</span>);
00212         exit(EXIT_FAILURE);
00213     }
00214     <span class="keywordflow">if</span> (bind
00215         (serverfd, (<span class="keyword">struct </span>sockaddr *) &amp;sain,
00216          <span class="keyword">sizeof</span>(<span class="keyword">struct </span>sockaddr_in)) == -1) {
00217         perror(<span class="stringliteral">"bind()"</span>);
00218         exit(EXIT_FAILURE);
00219     }
00220     <span class="keywordflow">if</span> (listen(serverfd, 5) == -1) {
00221         perror(<span class="stringliteral">"listen()"</span>);
00222         exit(EXIT_FAILURE);
00223     }
00224     <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(serverfd);
00225 
00226     printf(<span class="stringliteral">"listening on port %d\n"</span>, port);
00227 
00228     <span class="keywordflow">return</span> serverfd;
00229 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="mainloop_bad.c::main" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int main           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00379">379</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
References <a class="el" href="mainloop__bad_8c-source.html#l00042">BUFSIZE</a>, <a class="el" href="mainloop__bad_8c-source.html#l00076">chargenclient_t::fd</a>, <a class="el" href="mainloop__bad_8c-source.html#l00068">echoclient_t::fd</a>, <a class="el" href="mainloop__bad_8c-source.html#l00036">HEARTBEAT_INTERVAL</a>, <a class="el" href="mainloop__bad_8c-source.html#l00077">chargenclient_t::i</a>, <a class="el" href="mainloop__good_8c-source.html#l00359">listensocket()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00045">MAXCLIENTS</a>, <a class="el" href="mainloop__good_8c-source.html#l00170">message()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00050">MSG_ACCEPT</a>, <a class="el" href="mainloop__bad_8c-source.html#l00049">MSG_MAINLOOP</a>, <a class="el" href="mainloop__bad_8c-source.html#l00051">MSG_TOOMANY</a>, <a class="el" href="mainloop__bad_8c-source.html#l00071">echoclient_t::n</a>, <a class="el" href="mainloop__bad_8c-source.html#l00033">PORT_CHARGEN</a>, <a class="el" href="mainloop__bad_8c-source.html#l00030">PORT_ECHO</a>, <a class="el" href="mainloop__bad_8c-source.html#l00069">echoclient_t::r</a>, <a class="el" href="mainloop__good_8c-source.html#l00551">readecho()</a>, <a class="el" href="mainloop__good_8c-source.html#l00406">setnonblock()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00139">sighandler()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00039">SLOWHEARTBEAT_INTERVAL</a>, <a class="el" href="mainloop__bad_8c-source.html#l00070">echoclient_t::w</a>, <a class="el" href="mainloop__good_8c-source.html#l00706">writechargen()</a>, and <a class="el" href="mainloop__good_8c-source.html#l00598">writeecho()</a>.
<p>
<pre class="fragment"><div>00380 {
00381     <span class="keywordtype">int</span>             echoserverfd;
00382     <span class="keywordtype">int</span>             chargenserverfd;
00383     <a class="code" href="structechoclient__t.html">echoclient_t</a>    echoclients[<a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>];
00384     <a class="code" href="structchargenclient__t.html">chargenclient_t</a> chargenclients[<a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>];
00385     fd_set          rfdset, wfdset;
00386     <span class="keywordtype">int</span>             fdsetmax;
00387     <span class="keywordtype">int</span>             n, i;
00388     size_t          s;
00389     <span class="keyword">struct </span>sockaddr_in sain;
00390 
00391     printf(<span class="stringliteral">"example: bad main loop\n"</span>);
00392 
00393     <span class="comment">/* </span>
00394 <span class="comment">     * ignore SIGPIPE (this occurs whenever a chargen client closes</span>
00395 <span class="comment">     * the connection).</span>
00396 <span class="comment">     */</span>
00397     <span class="keywordflow">if</span> (signal(SIGPIPE, SIG_IGN) == SIG_ERR) {
00398         perror(<span class="stringliteral">"signal(SIGPIPE, SIG_IGN)"</span>);
00399         exit(EXIT_FAILURE);
00400     }
00401 
00402     <span class="comment">/* </span>
00403 <span class="comment">     * install heartbeat. this is done by calling the signal</span>
00404 <span class="comment">     * handler for SIGALRM which then installs itself as a signal</span>
00405 <span class="comment">     * handler and starts the alarm clock.</span>
00406 <span class="comment">     */</span>
00407     printf(<span class="stringliteral">"heartbeat every %d seconds\n"</span>, HEARTBEAT_INTERVAL);
00408     printf(<span class="stringliteral">"slow heartbeat every %d seconds\n"</span>, SLOWHEARTBEAT_INTERVAL);
00409     <a class="code" href="mainloop__bad_8c.html#a22">sighandler</a>(SIGALRM);
00410 
00411     <span class="comment">/* </span>
00412 <span class="comment">     * create server sockets for echo and chargen services</span>
00413 <span class="comment">     */</span>
00414     echoserverfd = <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(PORT_ECHO);
00415     chargenserverfd = <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(PORT_CHARGEN);
00416 
00417     <span class="comment">/* </span>
00418 <span class="comment">     * reset all client state slots (mark as unused)</span>
00419 <span class="comment">     */</span>
00420     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00421         echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> = -1;
00422         chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> = -1;
00423     }
00424 
00425     <span class="comment">/* </span>
00426 <span class="comment">     * initialize fdsets for select()</span>
00427 <span class="comment">     */</span>
00428     FD_ZERO(&amp;rfdset);
00429     FD_ZERO(&amp;wfdset);
00430     FD_SET(STDIN_FILENO, &amp;rfdset);
00431     FD_SET(echoserverfd, &amp;rfdset);      <span class="comment">/* fd 3 */</span>
00432     FD_SET(chargenserverfd, &amp;rfdset);   <span class="comment">/* fd 4 */</span>
00433     fdsetmax = chargenserverfd; <span class="comment">/* fd 4 */</span>
00434 
00435     <span class="comment">/* </span>
00436 <span class="comment">     * THE main loop</span>
00437 <span class="comment">     * Remeber, this is the bad example. On Solaris, select() is a</span>
00438 <span class="comment">     * (rather clumsy) wrapper around poll(). There is no way to efficiently</span>
00439 <span class="comment">     * emulate select() using poll().</span>
00440 <span class="comment">     */</span>
00441     <span class="keywordflow">while</span> (((n = select(fdsetmax + 1, &amp;rfdset, &amp;wfdset, NULL, NULL)) != -1)
00442            || (errno == EINTR)) {
00443         <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_MAINLOOP);
00444 
00445         <span class="keywordflow">if</span> (n == -1) {
00446             <span class="comment">/* got -1 and errno==EINTR */</span>
00447             <span class="keywordflow">continue</span>;
00448         }
00449 
00450         <span class="comment">/* </span>
00451 <span class="comment">         * check for new echo connections</span>
00452 <span class="comment">         */</span>
00453         <span class="keywordflow">if</span> (FD_ISSET(echoserverfd, &amp;rfdset)) {
00454             <span class="comment">/* find free slot */</span>
00455             <span class="keywordflow">for</span> (i = 0; (i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>) &amp;&amp; (echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> != -1);
00456                  i++);
00457             <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> != -1) {
00458                 <span class="comment">/* no free slots */</span>
00459                 s = <span class="keyword">sizeof</span>(sain);
00460                 i = accept(echoserverfd, (<span class="keyword">struct</span> sockaddr *) &amp;sain, &amp;s);
00461                 close(i);
00462                 <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_TOOMANY);
00463             } <span class="keywordflow">else</span> {
00464                 s = <span class="keyword">sizeof</span>(sain);
00465                 echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> =
00466                     accept(echoserverfd, (<span class="keyword">struct</span> sockaddr *) &amp;sain, &amp;s);
00467                 <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_ACCEPT);
00468                 <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(echoclients[i].fd);
00469                 echoclients[i].<a class="code" href="structechoclient__t.html#o1">r</a> = 0;   <span class="comment">/* start reading from buffer at pos 0 */</span>
00470                 echoclients[i].<a class="code" href="structechoclient__t.html#o2">w</a> = 0;   <span class="comment">/* start writing to buffer at pos 0 */</span>
00471                 echoclients[i].<a class="code" href="structechoclient__t.html#o3">n</a> = 0;   <span class="comment">/* 0 bytes in buffer */</span>
00472             }
00473         }
00474 
00475         <span class="comment">/* </span>
00476 <span class="comment">         * check for new chargen connections</span>
00477 <span class="comment">         */</span>
00478         <span class="keywordflow">if</span> (FD_ISSET(chargenserverfd, &amp;rfdset)) {
00479             <span class="comment">/* find free slot */</span>
00480             <span class="keywordflow">for</span> (i = 0; (i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>) &amp;&amp; (chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> != -1);
00481                  i++);
00482             <span class="keywordflow">if</span> (chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> != -1) {
00483                 <span class="comment">/* no free slots */</span>
00484                 s = <span class="keyword">sizeof</span>(sain);
00485                 i = accept(chargenserverfd, (<span class="keyword">struct</span> sockaddr *) &amp;sain, &amp;s);
00486                 close(i);
00487                 <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_TOOMANY);
00488             } <span class="keywordflow">else</span> {
00489                 s = <span class="keyword">sizeof</span>(sain);
00490                 chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> =
00491                     accept(chargenserverfd, (<span class="keyword">struct</span> sockaddr *) &amp;sain, &amp;s);
00492                 <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_ACCEPT);
00493                 <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(chargenclients[i].fd);
00494                 chargenclients[i].<a class="code" href="structchargenclient__t.html#o1">i</a> = 0;        <span class="comment">/* start sending from buffer</span>
00495 <span class="comment">                                                 * at pos 0 */</span>
00496             }
00497         }
00498 
00499         <span class="comment">/* </span>
00500 <span class="comment">         * try to read/write data for echo clients</span>
00501 <span class="comment">         */</span>
00502         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00503             <span class="keywordflow">if</span> ((echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> != -1)
00504                 &amp;&amp; (FD_ISSET(echoclients[i].fd, &amp;rfdset))) {
00505                 <a class="code" href="mainloop__good_8c.html#a42">readecho</a>(&amp;echoclients[i]);
00506             }
00507             <span class="keywordflow">if</span> ((echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> != -1)
00508                 &amp;&amp; (FD_ISSET(echoclients[i].fd, &amp;wfdset))) {
00509                 <a class="code" href="mainloop__good_8c.html#a43">writeecho</a>(&amp;echoclients[i]);
00510             }
00511         }
00512 
00513         <span class="comment">/* </span>
00514 <span class="comment">         * try to write data for chargen clients</span>
00515 <span class="comment">         */</span>
00516         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00517             <span class="keywordflow">if</span> ((chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> != -1)
00518                 &amp;&amp; (FD_ISSET(chargenclients[i].fd, &amp;wfdset))) {
00519                 <a class="code" href="mainloop__good_8c.html#a46">writechargen</a>(&amp;chargenclients[i]);
00520             }
00521         }
00522 
00523         <span class="comment">/* </span>
00524 <span class="comment">         * reinitialize fdset</span>
00525 <span class="comment">         */</span>
00526         FD_ZERO(&amp;rfdset);
00527         FD_ZERO(&amp;wfdset);
00528         fdsetmax = chargenserverfd;
00529         FD_SET(echoserverfd, &amp;rfdset);
00530         FD_SET(chargenserverfd, &amp;rfdset);
00531         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00532             <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> &gt;= 0) {
00533                 <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o3">n</a> &lt; <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>) {
00534                     FD_SET(echoclients[i].fd, &amp;rfdset);
00535                     <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> &gt; fdsetmax) {
00536                         fdsetmax = echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a>;
00537                     }
00538                 }
00539                 <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o3">n</a> &gt; 0) {
00540                     FD_SET(echoclients[i].fd, &amp;wfdset);
00541                     <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> &gt; fdsetmax) {
00542                         fdsetmax = echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a>;
00543                     }
00544                 }
00545             }
00546         }
00547         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00548             <span class="keywordflow">if</span> (chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> &gt;= 0) {
00549                 FD_SET(chargenclients[i].fd, &amp;wfdset);
00550                 <span class="keywordflow">if</span> (chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> &gt; fdsetmax) {
00551                     fdsetmax = chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a>;
00552                 }
00553             }
00554         }
00555     }
00556     <span class="comment">/* notreached */</span>
00557     exit(EXIT_FAILURE);
00558 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="mainloop_bad.c::message" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void message           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>msg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
print message describing current activity 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>msg</em>&nbsp;</td><td>id of message to print (MSG_XYZ) </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00096">96</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
References <a class="el" href="mainloop__bad_8c-source.html#l00050">MSG_ACCEPT</a>, <a class="el" href="mainloop__bad_8c-source.html#l00052">MSG_CLOSE</a>, <a class="el" href="mainloop__bad_8c-source.html#l00056">MSG_EMPTY</a>, <a class="el" href="mainloop__bad_8c-source.html#l00055">MSG_FULL</a>, <a class="el" href="mainloop__bad_8c-source.html#l00047">MSG_HEARTBEAT</a>, <a class="el" href="mainloop__bad_8c-source.html#l00049">MSG_MAINLOOP</a>, <a class="el" href="mainloop__bad_8c-source.html#l00053">MSG_READ</a>, <a class="el" href="mainloop__bad_8c-source.html#l00048">MSG_SLOWHEARTBEAT</a>, <a class="el" href="mainloop__bad_8c-source.html#l00051">MSG_TOOMANY</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00054">MSG_WRITE</a>.
<p>
<pre class="fragment"><div>00097 {
00098     <span class="keywordflow">switch</span> (msg) {
00099     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a6">MSG_HEARTBEAT</a>:
00100         printf(<span class="stringliteral">"H"</span>);
00101         <span class="keywordflow">break</span>;
00102     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a7">MSG_SLOWHEARTBEAT</a>:
00103         printf(<span class="stringliteral">"S"</span>);
00104         <span class="keywordflow">break</span>;
00105     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a8">MSG_MAINLOOP</a>:
00106         <span class="comment">/* printf("M"); */</span>
00107         <span class="keywordflow">break</span>;
00108     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a9">MSG_ACCEPT</a>:
00109         printf(<span class="stringliteral">"A"</span>);
00110         <span class="keywordflow">break</span>;
00111     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a10">MSG_TOOMANY</a>:
00112         printf(<span class="stringliteral">"T"</span>);
00113         <span class="keywordflow">break</span>;
00114     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a11">MSG_CLOSE</a>:
00115         printf(<span class="stringliteral">"C"</span>);
00116         <span class="keywordflow">break</span>;
00117     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a12">MSG_READ</a>:
00118         printf(<span class="stringliteral">"R"</span>);
00119         <span class="keywordflow">break</span>;
00120     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>:
00121         printf(<span class="stringliteral">"W"</span>);
00122         <span class="keywordflow">break</span>;
00123     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a14">MSG_FULL</a>:
00124         printf(<span class="stringliteral">"F"</span>);
00125         <span class="keywordflow">break</span>;
00126     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a15">MSG_EMPTY</a>:
00127         printf(<span class="stringliteral">"E"</span>);
00128         <span class="keywordflow">break</span>;
00129     }
00130     fflush(stdout);
00131 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="mainloop_bad.c::readecho" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void readecho           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="structechoclient__t.html">echoclient_t</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>client</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
read data from an echo client 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>client</em>&nbsp;</td><td>echo client state</td></tr>
  </table>
</dl>
If the buffer is not full, tries to do one read from the filedescriptor associated with the echo client. 
<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00257">257</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
References <a class="el" href="mainloop__bad_8c-source.html#l00072">echoclient_t::buf</a>, <a class="el" href="mainloop__bad_8c-source.html#l00042">BUFSIZE</a>, <a class="el" href="mainloop__bad_8c-source.html#l00068">echoclient_t::fd</a>, <a class="el" href="mainloop__good_8c-source.html#l00170">message()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00052">MSG_CLOSE</a>, <a class="el" href="mainloop__bad_8c-source.html#l00055">MSG_FULL</a>, <a class="el" href="mainloop__bad_8c-source.html#l00053">MSG_READ</a>, <a class="el" href="mainloop__bad_8c-source.html#l00071">echoclient_t::n</a>, <a class="el" href="mainloop__bad_8c-source.html#l00069">echoclient_t::r</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00070">echoclient_t::w</a>.
<p>
<pre class="fragment"><div>00258 {
00259     <span class="keywordtype">int</span>             nread;
00260 
00261     <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structechoclient__t.html#o3">n</a> == <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>) {
00262         <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_FULL);
00263         <span class="keywordflow">return</span>;
00264     }
00265 
00266     <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a> &gt;= client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>) {
00267         nread =
00268             read(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>, client-&gt;<a class="code" href="structechoclient__t.html#o4">buf</a> + client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a>, BUFSIZE - client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a>);
00269     } <span class="keywordflow">else</span> {
00270         nread =
00271             read(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>, client-&gt;<a class="code" href="structechoclient__t.html#o4">buf</a> + client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a>,
00272                  client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a> - client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a>);
00273     }
00274 
00275     <span class="keywordflow">switch</span> (nread) {
00276     <span class="keywordflow">case</span> 0:
00277         <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_CLOSE);
00278         close(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>);
00279         client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a> = -1;
00280         <span class="keywordflow">break</span>;
00281     <span class="keywordflow">case</span> -1:
00282         <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00283             perror(<span class="stringliteral">"read()"</span>);
00284             exit(EXIT_FAILURE);
00285         }
00286         <span class="keywordflow">break</span>;
00287     <span class="keywordflow">default</span>:
00288         <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_READ);
00289         client-&gt;<a class="code" href="structechoclient__t.html#o3">n</a> += nread;
00290         client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a> += nread;
00291         client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a> %= <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>;
00292     }
00293 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="mainloop_bad.c::setnonblock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void setnonblock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>fd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
set a file descriptor to be nonblocking 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>fd</em>&nbsp;</td><td>file descriptor</td></tr>
  </table>
</dl>
Non-Blocking works only for Sockets, Pipes and slow devices, it has no effect when used with regular files 
<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00240">240</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
<pre class="fragment"><div>00241 {
00242     <span class="keywordtype">int</span>             flag;
00243 
00244     flag = fcntl(fd, F_GETFL);
00245     fcntl(fd, F_GETFL, flag | O_NONBLOCK);
00246 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="mainloop_bad.c::sighandler" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void sighandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>signo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
signal handler 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>signo</em>&nbsp;</td><td>signal number </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00139">139</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
References <a class="el" href="mainloop__bad_8c-source.html#l00036">HEARTBEAT_INTERVAL</a>, <a class="el" href="mainloop__bad_8c-source.html#l00059">MAX</a>, <a class="el" href="mainloop__good_8c-source.html#l00170">message()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00058">MIN</a>, <a class="el" href="mainloop__bad_8c-source.html#l00047">MSG_HEARTBEAT</a>, <a class="el" href="mainloop__bad_8c-source.html#l00048">MSG_SLOWHEARTBEAT</a>, <a class="el" href="mainloop__bad_8c-source.html#l00139">sighandler()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00039">SLOWHEARTBEAT_INTERVAL</a>.
<p>
Referenced by <a class="el" href="mainloop__bad_8c-source.html#l00379">main()</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00139">sighandler()</a>.
<p>
<pre class="fragment"><div>00140 {
00141     <span class="keyword">struct </span>timeval  now;
00142     <span class="keyword">static</span> time_t   time_heartbeat, time_slowheartbeat;
00143     <span class="keywordtype">int</span>             nextalarm;
00144 
00145     <span class="keywordflow">switch</span> (signo) {
00146     <span class="keywordflow">case</span> SIGALRM:
00147         <span class="comment">/* </span>
00148 <span class="comment">         * (re)install signal handler and set new alarm</span>
00149 <span class="comment">         * there is a possible race condition, but for alarm()/SIGALRM this is not a real concern</span>
00150 <span class="comment">         */</span>
00151         <span class="keywordflow">if</span> (signal(SIGALRM, &amp;sighandler) == SIG_ERR) {
00152             perror(<span class="stringliteral">"signal(SIGALRM)"</span>);
00153             exit(EXIT_FAILURE);
00154         }
00155         gettimeofday(&amp;now, NULL);
00156         <span class="keywordflow">if</span> (time_heartbeat == 0) {
00157             time_heartbeat = now.tv_sec + <a class="code" href="mainloop__bad_8c.html#a2">HEARTBEAT_INTERVAL</a>;
00158             time_slowheartbeat = now.tv_sec + <a class="code" href="mainloop__bad_8c.html#a3">SLOWHEARTBEAT_INTERVAL</a>;
00159         }
00160         <span class="keywordflow">if</span> (time_heartbeat &lt;= now.tv_sec) {
00161             time_heartbeat += <a class="code" href="mainloop__bad_8c.html#a2">HEARTBEAT_INTERVAL</a>;
00162             <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_HEARTBEAT);
00163         }
00164         <span class="keywordflow">if</span> (time_slowheartbeat &lt;= now.tv_sec) {
00165             time_slowheartbeat += <a class="code" href="mainloop__bad_8c.html#a3">SLOWHEARTBEAT_INTERVAL</a>;
00166             <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_SLOWHEARTBEAT);
00167         }
00168 
00169         nextalarm =
00170             <a class="code" href="mainloop__bad_8c.html#a17">MAX</a>(1, <a class="code" href="mainloop__bad_8c.html#a16">MIN</a>(time_heartbeat, time_slowheartbeat) - now.tv_sec);
00171 
00172         <span class="keywordflow">if</span> (alarm(nextalarm) == -1) {
00173             perror(<span class="stringliteral">"alarm()"</span>);
00174             exit(EXIT_FAILURE);
00175         }
00176         <span class="keywordflow">break</span>;
00177     <span class="keywordflow">default</span>:
00178         <span class="comment">/* ignore everything */</span>
00179         <span class="keywordflow">break</span>;
00180     }
00181 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="mainloop_bad.c::writechargen" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void writechargen           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="structchargenclient__t.html">chargenclient_t</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>client</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
write data to a chargen client 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>client</em>&nbsp;</td><td>chargen client state </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00350">350</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
References <a class="el" href="mainloop__bad_8c-source.html#l00062">chargen_buf</a>, <a class="el" href="mainloop__bad_8c-source.html#l00076">chargenclient_t::fd</a>, <a class="el" href="mainloop__bad_8c-source.html#l00077">chargenclient_t::i</a>, <a class="el" href="mainloop__good_8c-source.html#l00170">message()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00052">MSG_CLOSE</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00054">MSG_WRITE</a>.
<p>
<pre class="fragment"><div>00351 {
00352     <span class="keywordtype">int</span>             nwrite;
00353 
00354     nwrite =
00355         write(client-&gt;<a class="code" href="structchargenclient__t.html#o0">fd</a>, chargen_buf + client-&gt;<a class="code" href="structchargenclient__t.html#o1">i</a>,
00356               <span class="keyword">sizeof</span>(chargen_buf) - client-&gt;<a class="code" href="structchargenclient__t.html#o1">i</a>);
00357 
00358     <span class="keywordflow">switch</span> (nwrite) {
00359     <span class="keywordflow">case</span> -1:
00360         <span class="keywordflow">if</span> (errno == EPIPE) {
00361             <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_CLOSE);
00362             close(client-&gt;<a class="code" href="structchargenclient__t.html#o0">fd</a>);
00363             client-&gt;<a class="code" href="structchargenclient__t.html#o0">fd</a> = -1;
00364         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00365             perror(<span class="stringliteral">"write()"</span>);
00366             exit(EXIT_FAILURE);
00367         }
00368         <span class="keywordflow">break</span>;
00369     <span class="keywordflow">case</span> 0:
00370         <span class="keywordflow">break</span>;
00371     <span class="keywordflow">default</span>:
00372         <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_WRITE);
00373         client-&gt;<a class="code" href="structchargenclient__t.html#o1">i</a> += nwrite;
00374         client-&gt;<a class="code" href="structchargenclient__t.html#o1">i</a> %= <span class="keyword">sizeof</span>(<a class="code" href="mainloop__bad_8c.html#a18">chargen_buf</a>);
00375     }
00376 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="mainloop_bad.c::writeecho" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void writeecho           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="structechoclient__t.html">echoclient_t</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>client</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
write data to an echo client 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>client</em>&nbsp;</td><td>echo client state</td></tr>
  </table>
</dl>
If the buffer is not empty, tries to do one write to the filedescriptor associated with the echo client. 
<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00304">304</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
References <a class="el" href="mainloop__bad_8c-source.html#l00072">echoclient_t::buf</a>, <a class="el" href="mainloop__bad_8c-source.html#l00042">BUFSIZE</a>, <a class="el" href="mainloop__bad_8c-source.html#l00068">echoclient_t::fd</a>, <a class="el" href="mainloop__good_8c-source.html#l00170">message()</a>, <a class="el" href="mainloop__bad_8c-source.html#l00052">MSG_CLOSE</a>, <a class="el" href="mainloop__bad_8c-source.html#l00056">MSG_EMPTY</a>, <a class="el" href="mainloop__bad_8c-source.html#l00054">MSG_WRITE</a>, <a class="el" href="mainloop__bad_8c-source.html#l00071">echoclient_t::n</a>, <a class="el" href="mainloop__bad_8c-source.html#l00069">echoclient_t::r</a>, and <a class="el" href="mainloop__bad_8c-source.html#l00070">echoclient_t::w</a>.
<p>
<pre class="fragment"><div>00305 {
00306     <span class="keywordtype">int</span>             nwrite;
00307 
00308     <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structechoclient__t.html#o3">n</a> == 0) {
00309         <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_EMPTY);
00310         <span class="keywordflow">return</span>;
00311     }
00312 
00313     <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a> &gt; client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>) {
00314         nwrite =
00315             write(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>, client-&gt;<a class="code" href="structechoclient__t.html#o4">buf</a> + client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>,
00316                   client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a> - client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>);
00317     } <span class="keywordflow">else</span> {
00318         nwrite =
00319             write(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>, client-&gt;<a class="code" href="structechoclient__t.html#o4">buf</a> + client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>,
00320                   BUFSIZE - client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>);
00321     }
00322 
00323     <span class="keywordflow">switch</span> (nwrite) {
00324     <span class="keywordflow">case</span> -1:
00325         <span class="keywordflow">if</span> (errno == EPIPE) {
00326             <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_CLOSE);
00327             close(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>);
00328             client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a> = -1;
00329         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00330             perror(<span class="stringliteral">"write()"</span>);
00331             exit(EXIT_FAILURE);
00332         }
00333         <span class="keywordflow">break</span>;
00334     <span class="keywordflow">case</span> 0:
00335         <span class="keywordflow">break</span>;
00336     <span class="keywordflow">default</span>:
00337         <a class="code" href="mainloop__good_8c.html#a26">message</a>(MSG_WRITE);
00338         client-&gt;<a class="code" href="structechoclient__t.html#o3">n</a> -= nwrite;
00339         client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a> += nwrite;
00340         client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a> %= <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>;
00341     }
00342 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a18" doxytag="mainloop_bad.c::chargen_buf" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> char <a class="el" href="mainloop__good_8c.html#a19">chargen_buf</a>[] = "0123456789abcdefghijklmnopqrstuv"<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
characters to 
<p>
<dl compact><dt><b>Returns:</b></dt><dd>in chargen service </dd></dl>

<p>
Definition at line <a class="el" href="mainloop__bad_8c-source.html#l00062">62</a> of file <a class="el" href="mainloop__bad_8c-source.html">mainloop_bad.c</a>.
<p>
Referenced by <a class="el" href="mainloop__bad_8c-source.html#l00350">writechargen()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Mon Jul 19 16:02:06 2004 for mainloop by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
