<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mainloop: mainloop_glib.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>mainloop_glib.c</h1><a href="mainloop__glib_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00010 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00011 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00012 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00013 <span class="preprocessor">#include &lt;string.h&gt;</span>
00014 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00015 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00016 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00017 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00018 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00019 
00020 <span class="preprocessor">#include "glib.h"</span>
00021 
<a name="l00023"></a><a class="code" href="mainloop__glib_8c.html#a0">00023</a> <span class="preprocessor">#define PORT_ECHO 5005</span>
00024 <span class="preprocessor"></span>
<a name="l00026"></a><a class="code" href="mainloop__glib_8c.html#a1">00026</a> <span class="preprocessor">#define PORT_CHARGEN 5006</span>
00027 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="mainloop__glib_8c.html#a2">00029</a> <span class="preprocessor">#define HEARTBEAT_INTERVAL 2</span>
00030 <span class="preprocessor"></span>
<a name="l00032"></a><a class="code" href="mainloop__glib_8c.html#a3">00032</a> <span class="preprocessor">#define SLOWHEARTBEAT_INTERVAL 15</span>
00033 <span class="preprocessor"></span>
<a name="l00035"></a><a class="code" href="mainloop__glib_8c.html#a4">00035</a> <span class="preprocessor">#define BUFSIZE 16</span>
00036 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="mainloop__glib_8c.html#a5">00037</a> <span class="preprocessor">#define MSG_HEARTBEAT 0</span>
<a name="l00038"></a><a class="code" href="mainloop__glib_8c.html#a6">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_SLOWHEARTBEAT 1</span>
<a name="l00039"></a><a class="code" href="mainloop__glib_8c.html#a7">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_MAINLOOP 2</span>
<a name="l00040"></a><a class="code" href="mainloop__glib_8c.html#a8">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_ACCEPT 3</span>
<a name="l00041"></a><a class="code" href="mainloop__glib_8c.html#a9">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_TOOMANY 4</span>
<a name="l00042"></a><a class="code" href="mainloop__glib_8c.html#a10">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_CLOSE 5</span>
<a name="l00043"></a><a class="code" href="mainloop__glib_8c.html#a11">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_READ 6</span>
<a name="l00044"></a><a class="code" href="mainloop__glib_8c.html#a12">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_WRITE 7</span>
<a name="l00045"></a><a class="code" href="mainloop__glib_8c.html#a13">00045</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_FULL 8</span>
<a name="l00046"></a><a class="code" href="mainloop__glib_8c.html#a14">00046</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_EMPTY 9</span>
00047 <span class="preprocessor"></span>
<a name="l00049"></a><a class="code" href="mainloop__glib_8c.html#a15">00049</a> <span class="keyword">static</span> <span class="keywordtype">char</span>     <a class="code" href="mainloop__glib_8c.html#a15">chargen_buf</a>[] = <span class="stringliteral">"0123456789abcdefghijklmnopqrstuv"</span>;
00050 
<a name="l00051"></a><a class="code" href="mainloop__glib_8c.html#a16">00051</a> <span class="keyword">typedef</span> GSource *(*getclientsourcefunc) ();
00052 
<a name="l00056"></a><a class="code" href="structlisten__source__t.html">00056</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00057"></a><a class="code" href="structlisten__source__t.html#o0">00057</a>     <a class="code" href="mainloop__glib_8c.html#a16">getclientsourcefunc</a> getclientsource;
00058 } <a class="code" href="structlisten__source__t.html">listen_source_t</a>;
00059 
<a name="l00063"></a><a class="code" href="structecho__source__t.html">00063</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00064"></a><a class="code" href="structecho__source__t.html#o0">00064</a>     <span class="keywordtype">int</span>             r;  
<a name="l00065"></a><a class="code" href="structecho__source__t.html#o1">00065</a>     <span class="keywordtype">int</span>             w;  
<a name="l00066"></a><a class="code" href="structecho__source__t.html#o2">00066</a>     <span class="keywordtype">int</span>             n;  
<a name="l00067"></a><a class="code" href="structecho__source__t.html#o3">00067</a>     <span class="keywordtype">char</span>            buf[<a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>];       
00068 } <a class="code" href="structecho__source__t.html">echo_source_t</a>;
00069 
<a name="l00073"></a><a class="code" href="structchargen__source__t.html">00073</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00074"></a><a class="code" href="structchargen__source__t.html#o0">00074</a>     <span class="keywordtype">int</span>             i;  
00075 } <a class="code" href="structchargen__source__t.html">chargen_source_t</a>;
00076 
<a name="l00077"></a><a class="code" href="structsource__t.html">00077</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00078"></a><a class="code" href="structsource__t.html#o0">00078</a>     GSource         source;     
<a name="l00079"></a><a class="code" href="structsource__t.html#o1">00079</a>     GPollFD         pollfd;     
<a name="l00080"></a><a class="code" href="structsource__t.html#o2">00080</a>     guint           <span class="keywordtype">id</span>;         
00082     <span class="keyword">union </span>{
<a name="l00083"></a><a class="code" href="structsource__t.html#o3">00083</a>         <a class="code" href="structlisten__source__t.html">listen_source_t</a> listen; 
<a name="l00084"></a><a class="code" href="structsource__t.html#o4">00084</a>         <a class="code" href="structecho__source__t.html">echo_source_t</a> echo;     
<a name="l00085"></a><a class="code" href="structsource__t.html#o5">00085</a>         <a class="code" href="structchargen__source__t.html">chargen_source_t</a> chargen;       
00086     };
00087 } <a class="code" href="structsource__t.html">source_t</a>;
00088 
00089 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<span class="keywordtype">int</span> msg);
00090 
00091 <span class="keyword">static</span> <span class="keywordtype">int</span>      <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(<span class="keywordtype">int</span> port);
00092 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(<span class="keywordtype">int</span> fd);
00093 
00094 <span class="keyword">static</span> <a class="code" href="structsource__t.html">source_t</a> *<a class="code" href="mainloop__glib_8c.html#a20">listensource</a>(<a class="code" href="mainloop__glib_8c.html#a16">getclientsourcefunc</a> getclientsource,
00095                               <span class="keywordtype">int</span> port);
00096 <span class="keyword">static</span> GSource *<a class="code" href="mainloop__glib_8c.html#a21">getechoclientsource</a>();
00097 <span class="keyword">static</span> GSource *<a class="code" href="mainloop__glib_8c.html#a22">getchargenclientsource</a>();
00098 
00099 <span class="keyword">static</span> gboolean <a class="code" href="mainloop__good_8c.html#a32">heartbeat</a>(gpointer data);
00100 <span class="keyword">static</span> gboolean <a class="code" href="mainloop__good_8c.html#a33">slowheartbeat</a>(gpointer data);
00101 
00102 <span class="keyword">static</span> gboolean <a class="code" href="mainloop__glib_8c.html#a25">check</a>(GSource * source);
00103 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__glib_8c.html#a26">source_close</a>(<a class="code" href="structsource__t.html">source_t</a> * source);
00104 
00105 <span class="keyword">static</span> gboolean <a class="code" href="mainloop__glib_8c.html#a27">accept_prepare</a>(GSource * source, gint * timeout);
00106 <span class="keyword">static</span> gboolean <a class="code" href="mainloop__glib_8c.html#a28">accept_dispatch</a>(GSource * source, GSourceFunc callback,
00107                                 gpointer user_data);
00108 
00109 <span class="keyword">static</span> gboolean <a class="code" href="mainloop__glib_8c.html#a29">echo_prepare</a>(GSource * source, gint * timeout);
00110 <span class="keyword">static</span> gboolean <a class="code" href="mainloop__glib_8c.html#a30">echo_dispatch</a>(GSource * source, GSourceFunc callback,
00111                               gpointer user_data);
00112 
00113 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__glib_8c.html#a31">echo_dispatch_read</a>(<a class="code" href="structsource__t.html">source_t</a> * echosource);
00114 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__glib_8c.html#a32">echo_dispatch_write</a>(<a class="code" href="structsource__t.html">source_t</a> * echosource);
00115 
00116 <span class="keyword">static</span> gboolean <a class="code" href="mainloop__glib_8c.html#a33">chargen_prepare</a>(GSource * source, gint * timeout);
00117 <span class="keyword">static</span> gboolean <a class="code" href="mainloop__glib_8c.html#a34">chargen_dispatch</a>(GSource * source, GSourceFunc callback,
00118                                  gpointer user_data);
00119 
00125 <span class="keywordtype">void</span>
<a name="l00126"></a><a class="code" href="mainloop__glib_8c.html#a17">00126</a> <a class="code" href="mainloop__good_8c.html#a26">message</a>(<span class="keywordtype">int</span> msg)
00127 {
00128     <span class="keywordflow">switch</span> (msg) {
00129     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a6">MSG_HEARTBEAT</a>:
00130         printf(<span class="stringliteral">"H"</span>);
00131         <span class="keywordflow">break</span>;
00132     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a7">MSG_SLOWHEARTBEAT</a>:
00133         printf(<span class="stringliteral">"S"</span>);
00134         <span class="keywordflow">break</span>;
00135     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a8">MSG_MAINLOOP</a>:
00136         printf(<span class="stringliteral">"M"</span>);
00137         <span class="keywordflow">break</span>;
00138     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a9">MSG_ACCEPT</a>:
00139         printf(<span class="stringliteral">"A"</span>);
00140         <span class="keywordflow">break</span>;
00141     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a10">MSG_TOOMANY</a>:
00142         printf(<span class="stringliteral">"T"</span>);
00143         <span class="keywordflow">break</span>;
00144     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a11">MSG_CLOSE</a>:
00145         printf(<span class="stringliteral">"C"</span>);
00146         <span class="keywordflow">break</span>;
00147     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a12">MSG_READ</a>:
00148         printf(<span class="stringliteral">"R"</span>);
00149         <span class="keywordflow">break</span>;
00150     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>:
00151         printf(<span class="stringliteral">"W"</span>);
00152         <span class="keywordflow">break</span>;
00153     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a14">MSG_FULL</a>:
00154         printf(<span class="stringliteral">"F"</span>);
00155         <span class="keywordflow">break</span>;
00156     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a15">MSG_EMPTY</a>:
00157         printf(<span class="stringliteral">"E"</span>);
00158         <span class="keywordflow">break</span>;
00159     }
00160     fflush(stdout);
00161 }
00162 
00169 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00170"></a><a class="code" href="mainloop__glib_8c.html#a35">00170</a> <a class="code" href="mainloop__glib_8c.html#a35">blocksigpipe</a>()
00171 {
00172     <span class="keyword">struct </span>sigaction act;
00173 
00174     act.sa_handler = SIG_IGN;
00175     sigemptyset(&amp;act.sa_mask);
00176     act.sa_flags = SA_RESTART;
00177     <span class="keywordflow">if</span> (sigaction(SIGPIPE, &amp;act, NULL) == -1) {
00178         perror(<span class="stringliteral">"sigaction(SIGPIPE, &lt;ignore&gt;)"</span>);
00179         exit(EXIT_FAILURE);
00180     }
00181 }
00182 
00192 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00193"></a><a class="code" href="mainloop__glib_8c.html#a18">00193</a> <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(<span class="keywordtype">int</span> port)
00194 {
00195     <span class="keywordtype">int</span>             serverfd;
00196     <span class="keyword">struct </span>sockaddr_in sain;
00197     <span class="keywordtype">int</span>             one;
00198 
00199     <span class="comment">/* set up tcp socket for listening */</span>
00200     sain.sin_family = AF_INET;
00201     sain.sin_port = htons(port);
00202     sain.sin_addr.s_addr = INADDR_ANY;
00203     <span class="keywordflow">if</span> ((serverfd = socket(AF_INET, SOCK_STREAM, 0)) == -1) {
00204         perror(<span class="stringliteral">"socket(AF_INET, SOCK_STREAM, 0)"</span>);
00205         exit(EXIT_FAILURE);
00206     }
00207     one = 1;
00208     <span class="keywordflow">if</span> (setsockopt
00209         (serverfd, SOL_SOCKET, SO_REUSEADDR, &amp;one,
00210          (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(one)) == -1) {
00211         perror(<span class="stringliteral">"setsockopt(SO_REUSEADDR)"</span>);
00212         exit(EXIT_FAILURE);
00213     }
00214     <span class="keywordflow">if</span> (bind
00215         (serverfd, (<span class="keyword">struct </span>sockaddr *) &amp;sain,
00216          <span class="keyword">sizeof</span>(<span class="keyword">struct </span>sockaddr_in)) == -1) {
00217         perror(<span class="stringliteral">"bind()"</span>);
00218         exit(EXIT_FAILURE);
00219     }
00220     <span class="keywordflow">if</span> (listen(serverfd, 5) == -1) {
00221         perror(<span class="stringliteral">"listen()"</span>);
00222         exit(EXIT_FAILURE);
00223     }
00224     <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(serverfd);
00225 
00226     printf(<span class="stringliteral">"listening on port %d\n"</span>, port);
00227 
00228     <span class="keywordflow">return</span> serverfd;
00229 }
00230 
00239 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00240"></a><a class="code" href="mainloop__glib_8c.html#a19">00240</a> <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(<span class="keywordtype">int</span> fd)
00241 {
00242     <span class="keywordtype">int</span>             flag;
00243 
00244     flag = fcntl(fd, F_GETFL);
00245     fcntl(fd, F_GETFL, flag | O_NONBLOCK);
00246 }
00247 
00256 <span class="keyword">static</span> <a class="code" href="structsource__t.html">source_t</a> *
<a name="l00257"></a><a class="code" href="mainloop__glib_8c.html#a20">00257</a> <a class="code" href="mainloop__glib_8c.html#a20">listensource</a>(getclientsourcefunc getclientsource, <span class="keywordtype">int</span> port)
00258 {
00259     <span class="keyword">static</span> GSourceFuncs listenfuncs;
00260     <a class="code" href="structsource__t.html">source_t</a>       *<a class="code" href="mainloop__glib_8c.html#a20">listensource</a>;
00261 
00262     listenfuncs.prepare = &amp;<a class="code" href="mainloop__glib_8c.html#a27">accept_prepare</a>;
00263     listenfuncs.check = &amp;<a class="code" href="mainloop__glib_8c.html#a25">check</a>;
00264     listenfuncs.dispatch = &amp;<a class="code" href="mainloop__glib_8c.html#a28">accept_dispatch</a>;
00265     listenfuncs.finalize = NULL;
00266     <a class="code" href="mainloop__glib_8c.html#a20">listensource</a> =
00267         (<a class="code" href="structsource__t.html">source_t</a> *) g_source_new(&amp;listenfuncs, <span class="keyword">sizeof</span>(<a class="code" href="structsource__t.html">source_t</a>));
00268     <a class="code" href="mainloop__glib_8c.html#a20">listensource</a>-&gt;<a class="code" href="structsource__t.html#o3">listen</a>.<a class="code" href="structlisten__source__t.html#o0">getclientsource</a> = getclientsource;
00269 
00270     <a class="code" href="mainloop__glib_8c.html#a20">listensource</a>-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.fd = <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(port);
00271     g_source_add_poll((GSource *) <a class="code" href="mainloop__glib_8c.html#a20">listensource</a>, &amp;(<a class="code" href="mainloop__glib_8c.html#a20">listensource</a>-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>));
00272     <span class="keywordflow">return</span> <a class="code" href="mainloop__glib_8c.html#a20">listensource</a>;
00273 }
00274 
00280 <span class="keyword">static</span>          gboolean
<a name="l00281"></a><a class="code" href="mainloop__glib_8c.html#a23">00281</a> <a class="code" href="mainloop__good_8c.html#a32">heartbeat</a>(gpointer data)
00282 {
00283     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a6">MSG_HEARTBEAT</a>);
00284     <span class="keywordflow">return</span> TRUE;
00285 }
00286 
00292 <span class="keyword">static</span>          gboolean
<a name="l00293"></a><a class="code" href="mainloop__glib_8c.html#a24">00293</a> <a class="code" href="mainloop__good_8c.html#a33">slowheartbeat</a>(gpointer data)
00294 {
00295     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a7">MSG_SLOWHEARTBEAT</a>);
00296     <span class="keywordflow">return</span> TRUE;
00297 }
00298 
00306 <span class="keyword">static</span>          gboolean
<a name="l00307"></a><a class="code" href="mainloop__glib_8c.html#a25">00307</a> <a class="code" href="mainloop__glib_8c.html#a25">check</a>(GSource * source)
00308 {
00309 
00310     <a class="code" href="structsource__t.html">source_t</a>       *xsource;
00311 
00312     xsource = (<a class="code" href="structsource__t.html">source_t</a> *) source;
00313 
00314     <span class="keywordflow">return</span> xsource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.revents ? TRUE : FALSE;
00315 }
00316 
00325 <span class="keyword">static</span>          gboolean
<a name="l00326"></a><a class="code" href="mainloop__glib_8c.html#a27">00326</a> <a class="code" href="mainloop__glib_8c.html#a27">accept_prepare</a>(GSource * source, gint * timeout)
00327 {
00328     <a class="code" href="structsource__t.html">source_t</a>       *xsource;
00329 
00330     xsource = (<a class="code" href="structsource__t.html">source_t</a> *) source;
00331 
00332     xsource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.events = G_IO_IN;
00333     *timeout = -1;              <span class="comment">/* no timeout */</span>
00334     <span class="keywordflow">return</span> FALSE;
00335 }
00336 
00346 <span class="keyword">static</span>          gboolean
<a name="l00347"></a><a class="code" href="mainloop__glib_8c.html#a28">00347</a> <a class="code" href="mainloop__glib_8c.html#a28">accept_dispatch</a>(GSource * gsource, GSourceFunc callback,
00348                 gpointer user_data)
00349 {
00350     <span class="keyword">struct </span>sockaddr_in sain;
00351     <span class="keywordtype">int</span>             fd;
00352     socklen_t       t;
00353     <a class="code" href="structsource__t.html">source_t</a>       *source;
00354     <a class="code" href="structsource__t.html">source_t</a>       *clientsource;
00355 
00356     source = (<a class="code" href="structsource__t.html">source_t</a> *) gsource;
00357 
00358     <span class="keywordflow">if</span> (source-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.revents &amp; (G_IO_HUP | G_IO_ERR)) {
00359         perror(<span class="stringliteral">"accept_dispatch()"</span>);
00360         exit(EXIT_FAILURE);
00361     }
00362 
00363     <span class="comment">/* accept new connection */</span>
00364     t = <span class="keyword">sizeof</span>(sain);
00365     <span class="keywordflow">if</span> ((fd = accept(source-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.fd, (<span class="keywordtype">void</span> *) &amp;sain, &amp;t)) == -1) {
00366         <span class="keywordflow">if</span> (errno == EWOULDBLOCK) {
00367             <span class="keywordflow">return</span> TRUE;
00368         }
00369         perror(<span class="stringliteral">"accept(ECHO)"</span>);
00370         exit(EXIT_FAILURE);
00371     }
00372     <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(fd);
00373     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a9">MSG_ACCEPT</a>);
00374 
00375     clientsource = (<a class="code" href="structsource__t.html">source_t</a> *) source-&gt;<a class="code" href="structsource__t.html#o3">listen</a>.<a class="code" href="structlisten__source__t.html#o0">getclientsource</a>();
00376     clientsource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.fd = fd;
00377     g_source_add_poll((GSource *) clientsource, &amp;(clientsource-&gt;pollfd));
00378     clientsource-&gt;id =
00379         g_source_attach((GSource *) clientsource,
00380                         g_source_get_context((GSource *) clientsource));
00381     <span class="keywordflow">return</span> TRUE;
00382 }
00383 
00389 <span class="keyword">static</span> GSource *
<a name="l00390"></a><a class="code" href="mainloop__glib_8c.html#a21">00390</a> <a class="code" href="mainloop__glib_8c.html#a21">getechoclientsource</a>()
00391 {
00392     <span class="keyword">static</span> GSourceFuncs funcs = { NULL, NULL, NULL, NULL, NULL, NULL };
00393     <a class="code" href="structsource__t.html">source_t</a>       *echosource;
00394 
00395     <span class="comment">/* cannot reference functions in static initializer */</span>
00396     funcs.prepare = <a class="code" href="mainloop__glib_8c.html#a29">echo_prepare</a>;
00397     funcs.check = <a class="code" href="mainloop__glib_8c.html#a25">check</a>;
00398     funcs.dispatch = <a class="code" href="mainloop__glib_8c.html#a30">echo_dispatch</a>;
00399     funcs.finalize = NULL;
00400 
00401     echosource = (<a class="code" href="structsource__t.html">source_t</a> *) g_source_new(&amp;funcs, <span class="keyword">sizeof</span>(<a class="code" href="structsource__t.html">source_t</a>));
00402     echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o0">r</a> = 0;
00403     echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o1">w</a> = 0;
00404     echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o2">n</a> = 0;
00405     <span class="keywordflow">return</span> (GSource *) echosource;
00406 }
00407 
00413 <span class="keyword">static</span> GSource *
<a name="l00414"></a><a class="code" href="mainloop__glib_8c.html#a22">00414</a> <a class="code" href="mainloop__glib_8c.html#a22">getchargenclientsource</a>()
00415 {
00416     <span class="keyword">static</span> GSourceFuncs funcs = { NULL, NULL, NULL, NULL, NULL, NULL };
00417     <a class="code" href="structsource__t.html">source_t</a>       *chargensource;
00418 
00419     <span class="comment">/* cannot reference functions in static initializer */</span>
00420     funcs.prepare = <a class="code" href="mainloop__glib_8c.html#a33">chargen_prepare</a>;
00421     funcs.check = <a class="code" href="mainloop__glib_8c.html#a25">check</a>;
00422     funcs.dispatch = <a class="code" href="mainloop__glib_8c.html#a34">chargen_dispatch</a>;
00423     funcs.finalize = NULL;
00424 
00425     chargensource = (<a class="code" href="structsource__t.html">source_t</a> *) g_source_new(&amp;funcs, <span class="keyword">sizeof</span>(<a class="code" href="structsource__t.html">source_t</a>));
00426     chargensource-&gt;<a class="code" href="structsource__t.html#o5">chargen</a>.<a class="code" href="structchargen__source__t.html#o0">i</a> = 0;
00427     <span class="keywordflow">return</span> (GSource *) chargensource;
00428 }
00429 
00441 <span class="keyword">static</span>          gboolean
<a name="l00442"></a><a class="code" href="mainloop__glib_8c.html#a29">00442</a> <a class="code" href="mainloop__glib_8c.html#a29">echo_prepare</a>(GSource * source, gint * timeout)
00443 {
00444     <a class="code" href="structsource__t.html">source_t</a>       *echosource;
00445 
00446     echosource = (<a class="code" href="structsource__t.html">source_t</a> *) source;
00447 
00448     <span class="keywordflow">switch</span> (echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o2">n</a>) {
00449     <span class="keywordflow">case</span> 0:
00450         echosource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.events = G_IO_IN;
00451         <span class="keywordflow">break</span>;
00452     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>:
00453         echosource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.events = G_IO_OUT;
00454         <span class="keywordflow">break</span>;
00455     <span class="keywordflow">default</span>:
00456         echosource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.events = G_IO_IN | G_IO_OUT;
00457     }
00458     <span class="keywordflow">return</span> FALSE;
00459 }
00460 
00470 <span class="keyword">static</span>          gboolean
<a name="l00471"></a><a class="code" href="mainloop__glib_8c.html#a30">00471</a> <a class="code" href="mainloop__glib_8c.html#a30">echo_dispatch</a>(GSource * source, GSourceFunc callback, gpointer user_data)
00472 {
00473     <a class="code" href="structsource__t.html">source_t</a>       *echosource;
00474 
00475     echosource = (<a class="code" href="structsource__t.html">source_t</a> *) source;
00476 
00477     <span class="keywordflow">if</span> (echosource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.revents &amp; (G_IO_HUP | G_IO_ERR)) {
00478         <a class="code" href="mainloop__glib_8c.html#a26">source_close</a>((<a class="code" href="structsource__t.html">source_t</a> *) echosource);
00479     }
00480     <span class="keywordflow">if</span> (echosource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.revents &amp; G_IO_IN) {
00481         <a class="code" href="mainloop__glib_8c.html#a31">echo_dispatch_read</a>(echosource);
00482     }
00483     <span class="keywordflow">if</span> (echosource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.revents &amp; G_IO_OUT) {
00484         <a class="code" href="mainloop__glib_8c.html#a32">echo_dispatch_write</a>(echosource);
00485     }
00486     <span class="keywordflow">return</span> TRUE;
00487 }
00488 
00497 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00498"></a><a class="code" href="mainloop__glib_8c.html#a31">00498</a> <a class="code" href="mainloop__glib_8c.html#a31">echo_dispatch_read</a>(<a class="code" href="structsource__t.html">source_t</a> * echosource)
00499 {
00500     ssize_t         nread;
00501 
00502     <span class="keywordflow">if</span> (echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o2">n</a> == <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>) {
00503         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a14">MSG_FULL</a>);
00504         <span class="keywordflow">return</span>;
00505     }
00506 
00507     <span class="keywordflow">if</span> (echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o0">r</a> &gt;= echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o1">w</a>) {
00508         nread =
00509             read(echosource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.fd,
00510                  echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o3">buf</a> + echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o0">r</a>,
00511                  <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a> - echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o0">r</a>);
00512     } <span class="keywordflow">else</span> {
00513         nread =
00514             read(echosource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.fd,
00515                  echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o3">buf</a> + echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o0">r</a>,
00516                  echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o1">w</a> - echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o0">r</a>);
00517     }
00518 
00519     <span class="keywordflow">switch</span> (nread) {
00520     <span class="keywordflow">case</span> -1:
00521         <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00522             perror(<span class="stringliteral">"read()"</span>);
00523             exit(EXIT_FAILURE);
00524         }
00525         <span class="keywordflow">break</span>;
00526     <span class="keywordflow">case</span> 0:
00527         <a class="code" href="mainloop__glib_8c.html#a26">source_close</a>((<a class="code" href="structsource__t.html">source_t</a> *) echosource);
00528         <span class="keywordflow">return</span>;
00529     <span class="keywordflow">default</span>:
00530         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a12">MSG_READ</a>);
00531         echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o2">n</a> += nread;
00532         echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o0">r</a> += nread;
00533         echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o0">r</a> %= <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>;
00534     }
00535 }
00536 
00545 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00546"></a><a class="code" href="mainloop__glib_8c.html#a32">00546</a> <a class="code" href="mainloop__glib_8c.html#a32">echo_dispatch_write</a>(<a class="code" href="structsource__t.html">source_t</a> * echosource)
00547 {
00548     ssize_t         nwrite;
00549 
00550     <span class="keywordflow">if</span> (echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o2">n</a> == 0) {
00551         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a15">MSG_EMPTY</a>);
00552         <span class="keywordflow">return</span>;
00553     }
00554 
00555     <span class="keywordflow">if</span> (echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o0">r</a> &gt; echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o1">w</a>) {
00556         nwrite =
00557             write(echosource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.fd,
00558                   echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o3">buf</a> + echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o1">w</a>,
00559                   echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o0">r</a> - echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o1">w</a>);
00560     } <span class="keywordflow">else</span> {
00561         nwrite =
00562             write(echosource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.fd,
00563                   echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o3">buf</a> + echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o1">w</a>,
00564                   <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a> - echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o1">w</a>);
00565     }
00566 
00567     <span class="keywordflow">switch</span> (nwrite) {
00568     <span class="keywordflow">case</span> -1:
00569         <span class="keywordflow">if</span> (errno == EPIPE) {
00570             <a class="code" href="mainloop__glib_8c.html#a26">source_close</a>((<a class="code" href="structsource__t.html">source_t</a> *) echosource);
00571         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00572             perror(<span class="stringliteral">"write()"</span>);
00573             exit(EXIT_FAILURE);
00574         }
00575         <span class="keywordflow">break</span>;
00576     <span class="keywordflow">case</span> 0:
00577         <span class="keywordflow">break</span>;
00578     <span class="keywordflow">default</span>:
00579         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>);
00580         echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o2">n</a> -= nwrite;
00581         echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o1">w</a> += nwrite;
00582         echosource-&gt;<a class="code" href="structsource__t.html#o4">echo</a>.<a class="code" href="structecho__source__t.html#o1">w</a> %= <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>;
00583     }
00584 }
00585 
00591 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00592"></a><a class="code" href="mainloop__glib_8c.html#a26">00592</a> <a class="code" href="mainloop__glib_8c.html#a26">source_close</a>(<a class="code" href="structsource__t.html">source_t</a> * source)
00593 {
00594     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a11">MSG_CLOSE</a>);
00595     (<span class="keywordtype">void</span>) g_source_remove(source-&gt;<a class="code" href="structsource__t.html#o2">id</a>);
00596     close(source-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.fd);
00597     g_source_unref((GSource *) source);
00598 }
00599 
00608 <span class="keyword">static</span>          gboolean
<a name="l00609"></a><a class="code" href="mainloop__glib_8c.html#a33">00609</a> <a class="code" href="mainloop__glib_8c.html#a33">chargen_prepare</a>(GSource * source, gint * timeout)
00610 {
00611     <a class="code" href="structsource__t.html">source_t</a>       *chargensource;
00612 
00613     chargensource = (<a class="code" href="structsource__t.html">source_t</a> *) source;
00614 
00615     chargensource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.events = G_IO_OUT;
00616 
00617     <span class="keywordflow">return</span> FALSE;
00618 }
00619 
00632 <span class="keyword">static</span>          gboolean
<a name="l00633"></a><a class="code" href="mainloop__glib_8c.html#a34">00633</a> <a class="code" href="mainloop__glib_8c.html#a34">chargen_dispatch</a>(GSource * source, GSourceFunc callback,
00634                  gpointer user_data)
00635 {
00636     ssize_t         nwrite;
00637     <a class="code" href="structsource__t.html">source_t</a>       *chargensource;
00638 
00639     chargensource = (<a class="code" href="structsource__t.html">source_t</a> *) source;
00640 
00641     nwrite =
00642         write(chargensource-&gt;<a class="code" href="structsource__t.html#o1">pollfd</a>.fd,
00643               <a class="code" href="mainloop__glib_8c.html#a15">chargen_buf</a> + chargensource-&gt;<a class="code" href="structsource__t.html#o5">chargen</a>.<a class="code" href="structchargen__source__t.html#o0">i</a>,
00644               <span class="keyword">sizeof</span>(<a class="code" href="mainloop__glib_8c.html#a15">chargen_buf</a>) - chargensource-&gt;<a class="code" href="structsource__t.html#o5">chargen</a>.<a class="code" href="structchargen__source__t.html#o0">i</a>);
00645     <span class="keywordflow">switch</span> (nwrite) {
00646     <span class="keywordflow">case</span> -1:
00647         <span class="keywordflow">if</span> (errno == EPIPE) {
00648             <a class="code" href="mainloop__glib_8c.html#a26">source_close</a>((<a class="code" href="structsource__t.html">source_t</a> *) chargensource);
00649             <span class="keywordflow">return</span> TRUE;
00650         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00651             perror(<span class="stringliteral">"write()"</span>);
00652             exit(EXIT_FAILURE);
00653         }
00654         <span class="keywordflow">break</span>;
00655     <span class="keywordflow">case</span> 0:
00656         <span class="keywordflow">break</span>;
00657     <span class="keywordflow">default</span>:
00658         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>);
00659         chargensource-&gt;<a class="code" href="structsource__t.html#o5">chargen</a>.<a class="code" href="structchargen__source__t.html#o0">i</a> += nwrite;
00660         chargensource-&gt;<a class="code" href="structsource__t.html#o5">chargen</a>.<a class="code" href="structchargen__source__t.html#o0">i</a> %= <span class="keyword">sizeof</span>(<a class="code" href="mainloop__glib_8c.html#a15">chargen_buf</a>);
00661     }
00662     <span class="keywordflow">return</span> TRUE;
00663 }
00664 
00665 <span class="keywordtype">int</span>
<a name="l00666"></a><a class="code" href="mainloop__glib_8c.html#a36">00666</a> <a class="code" href="mainloop__bad_8c.html#a26">main</a>()
00667 {
00668     GMainLoop      *mainloop;
00669     GMainContext   *context;
00670     <a class="code" href="structsource__t.html">source_t</a>       *listenecho, *listenchargen;
00671 
00672     <span class="comment">/* check glib version */</span>
00673     <span class="keywordflow">if</span> (!GLIB_CHECK_VERSION(2, 0, 0)) {
00674         fprintf(stderr, <span class="stringliteral">"glib %d.%d.%d is too old\n"</span>, GLIB_MAJOR_VERSION,
00675                 GLIB_MINOR_VERSION, GLIB_MICRO_VERSION);
00676         exit(EXIT_FAILURE);
00677     }
00678 
00679     printf(<span class="stringliteral">"example: glib main loop\n"</span>);
00680 
00681     <a class="code" href="mainloop__glib_8c.html#a35">blocksigpipe</a>();
00682 
00683     <span class="comment">/* create main loop */</span>
00684     context = g_main_context_default();
00685     mainloop = g_main_loop_new(context, FALSE);
00686 
00687     <span class="comment">/* create echo service */</span>
00688     listenecho = <a class="code" href="mainloop__glib_8c.html#a20">listensource</a>(<a class="code" href="mainloop__glib_8c.html#a21">getechoclientsource</a>, <a class="code" href="mainloop__bad_8c.html#a0">PORT_ECHO</a>);
00689     listenecho-&gt;<a class="code" href="structsource__t.html#o2">id</a> = g_source_attach((GSource *) listenecho, context);
00690 
00691     <span class="comment">/* create chargen service */</span>
00692     listenchargen = <a class="code" href="mainloop__glib_8c.html#a20">listensource</a>(<a class="code" href="mainloop__glib_8c.html#a22">getchargenclientsource</a>, <a class="code" href="mainloop__bad_8c.html#a1">PORT_CHARGEN</a>);
00693     listenchargen-&gt;<a class="code" href="structsource__t.html#o2">id</a> =
00694         g_source_attach((GSource *) listenchargen, context);
00695 
00696     <span class="comment">/* install heartbeat */</span>
00697     (<span class="keywordtype">void</span>) g_timeout_add(1000 * <a class="code" href="mainloop__bad_8c.html#a2">HEARTBEAT_INTERVAL</a>, &amp;<a class="code" href="mainloop__glib_8c.html#a23">heartbeat</a>, NULL);
00698     (<span class="keywordtype">void</span>) g_timeout_add(1000 * <a class="code" href="mainloop__bad_8c.html#a3">SLOWHEARTBEAT_INTERVAL</a>, &amp;<a class="code" href="mainloop__glib_8c.html#a24">slowheartbeat</a>, NULL);
00699     printf(<span class="stringliteral">"heartbeat every %d seconds\n"</span>, <a class="code" href="mainloop__bad_8c.html#a2">HEARTBEAT_INTERVAL</a>);
00700     printf(<span class="stringliteral">"slow heartbeat every %d seconds\n"</span>, <a class="code" href="mainloop__bad_8c.html#a3">SLOWHEARTBEAT_INTERVAL</a>);
00701 
00702     <span class="comment">/* run the main loop */</span>
00703     g_main_loop_run(mainloop);
00704     <span class="comment">/* notreached */</span>
00705 
00706     g_main_loop_unref(mainloop);
00707     exit(EXIT_SUCCESS);
00708 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 19 16:02:06 2004 for mainloop by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
