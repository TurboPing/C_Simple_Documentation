<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mainloop: mainloop_good.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>mainloop_good.c</h1><a href="mainloop__good_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00014 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00015 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00016 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00017 <span class="preprocessor">#include &lt;string.h&gt;</span>
00018 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00019 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00020 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00021 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00022 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00023 
<a name="l00025"></a><a class="code" href="mainloop__good_8c.html#a0">00025</a> <span class="preprocessor">#define PORT_ECHO 5005</span>
00026 <span class="preprocessor"></span>
<a name="l00028"></a><a class="code" href="mainloop__good_8c.html#a1">00028</a> <span class="preprocessor">#define PORT_CHARGEN 5006</span>
00029 <span class="preprocessor"></span>
<a name="l00031"></a><a class="code" href="mainloop__good_8c.html#a2">00031</a> <span class="preprocessor">#define HEARTBEAT_INTERVAL 2</span>
00032 <span class="preprocessor"></span>
<a name="l00034"></a><a class="code" href="mainloop__good_8c.html#a3">00034</a> <span class="preprocessor">#define SLOWHEARTBEAT_INTERVAL 15</span>
00035 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="mainloop__good_8c.html#a4">00037</a> <span class="preprocessor">#define BUFSIZE 16</span>
00038 <span class="preprocessor"></span>
<a name="l00040"></a><a class="code" href="mainloop__good_8c.html#a5">00040</a> <span class="preprocessor">#define MAXCLIENTS 8</span>
00041 <span class="preprocessor"></span>
<a name="l00043"></a><a class="code" href="mainloop__good_8c.html#a6">00043</a> <span class="preprocessor">#define MAXALARMS 8</span>
00044 <span class="preprocessor"></span>
<a name="l00045"></a><a class="code" href="mainloop__good_8c.html#a7">00045</a> <span class="preprocessor">#define MSG_HEARTBEAT 0</span>
<a name="l00046"></a><a class="code" href="mainloop__good_8c.html#a8">00046</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_SLOWHEARTBEAT 1</span>
<a name="l00047"></a><a class="code" href="mainloop__good_8c.html#a9">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_MAINLOOP 2</span>
<a name="l00048"></a><a class="code" href="mainloop__good_8c.html#a10">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_ACCEPT 3</span>
<a name="l00049"></a><a class="code" href="mainloop__good_8c.html#a11">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_TOOMANY 4</span>
<a name="l00050"></a><a class="code" href="mainloop__good_8c.html#a12">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_CLOSE 5</span>
<a name="l00051"></a><a class="code" href="mainloop__good_8c.html#a13">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_READ 6</span>
<a name="l00052"></a><a class="code" href="mainloop__good_8c.html#a14">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_WRITE 7</span>
<a name="l00053"></a><a class="code" href="mainloop__good_8c.html#a15">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_FULL 8</span>
<a name="l00054"></a><a class="code" href="mainloop__good_8c.html#a16">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_EMPTY 9</span>
00055 <span class="preprocessor"></span>
<a name="l00056"></a><a class="code" href="mainloop__good_8c.html#a17">00056</a> <span class="preprocessor">#define MIN(a, b)       ((a)&lt;(b)?(a):(b))</span>
<a name="l00057"></a><a class="code" href="mainloop__good_8c.html#a18">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX(a, b)       ((a)&gt;(b)?(a):(b))</span>
00058 <span class="preprocessor"></span>
<a name="l00060"></a><a class="code" href="mainloop__good_8c.html#a19">00060</a> <span class="keyword">static</span> <span class="keywordtype">char</span>     <a class="code" href="mainloop__good_8c.html#a19">chargen_buf</a>[] = <span class="stringliteral">"0123456789abcdefghijklmnopqrstuv"</span>;
00061 
<a name="l00065"></a><a class="code" href="structecho__client__t.html">00065</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00066"></a><a class="code" href="structecho__client__t.html#o0">00066</a>     <span class="keywordtype">int</span>             r;          
<a name="l00067"></a><a class="code" href="structecho__client__t.html#o1">00067</a>     <span class="keywordtype">int</span>             w;          
<a name="l00068"></a><a class="code" href="structecho__client__t.html#o2">00068</a>     <span class="keywordtype">int</span>             n;          
<a name="l00069"></a><a class="code" href="structecho__client__t.html#o3">00069</a>     <span class="keywordtype">char</span>            buf[<a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>];       
00070 } <a class="code" href="structecho__client__t.html">echo_client_t</a>;
00071 
<a name="l00075"></a><a class="code" href="structchargen__client__t.html">00075</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00076"></a><a class="code" href="structchargen__client__t.html#o0">00076</a>     <span class="keywordtype">int</span>             i;          
00077 } <a class="code" href="structchargen__client__t.html">chargen_client_t</a>;
00078 
<a name="l00084"></a><a class="code" href="mainloop__good_8c.html#a20">00084</a> <span class="keyword">typedef</span> void    (*<a class="code" href="mainloop__good_8c.html#a20">eventhandler_t</a>) (<span class="keywordtype">int</span> i);
00085 
<a name="l00092"></a><a class="code" href="structclient__t.html">00092</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00093"></a><a class="code" href="structclient__t.html#o0">00093</a>     <span class="keywordtype">int</span>             fd;         
<a name="l00094"></a><a class="code" href="structclient__t.html#o1">00094</a>     <a class="code" href="mainloop__good_8c.html#a20">eventhandler_t</a>  read;       
<a name="l00095"></a><a class="code" href="structclient__t.html#o2">00095</a>     <a class="code" href="mainloop__good_8c.html#a20">eventhandler_t</a>  write;      
<a name="l00096"></a><a class="code" href="structclient__t.html#o3">00096</a>     <a class="code" href="mainloop__good_8c.html#a20">eventhandler_t</a>  except;     
00097     <span class="keyword">union </span>{
<a name="l00098"></a><a class="code" href="structclient__t.html#o4">00098</a>         <a class="code" href="structecho__client__t.html">echo_client_t</a>   echo;   
<a name="l00099"></a><a class="code" href="structclient__t.html#o5">00099</a>         <a class="code" href="structchargen__client__t.html">chargen_client_t</a> chargen;       
00100     };
00101 } <a class="code" href="structclient__t.html">client_t</a>;
00102 
<a name="l00106"></a><a class="code" href="mainloop__good_8c.html#a21">00106</a> <span class="keyword">typedef</span> void    (*<a class="code" href="mainloop__good_8c.html#a21">alarmhandler_t</a>) (<span class="keywordtype">void</span>);
00107 
<a name="l00114"></a><a class="code" href="structalarm__t.html">00114</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00115"></a><a class="code" href="structalarm__t.html#o0">00115</a>     <a class="code" href="mainloop__good_8c.html#a21">alarmhandler_t</a>  handler;    
<a name="l00116"></a><a class="code" href="structalarm__t.html#o1">00116</a>     <span class="keywordtype">long</span>            interval;   
<a name="l00117"></a><a class="code" href="structalarm__t.html#o2">00117</a>     <span class="keywordtype">long</span>            nexttime;   
<a name="l00118"></a><a class="code" href="structalarm__t.html#o3">00118</a>     <span class="keywordtype">int</span>             flag;       
00119 } <a class="code" href="structalarm__t.html">alarm_t</a>;
00120 
<a name="l00131"></a><a class="code" href="mainloop__good_8c.html#a22">00131</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="mainloop__good_8c.html#a22">npollfd</a>;   
<a name="l00132"></a><a class="code" href="mainloop__good_8c.html#a23">00132</a> <span class="keyword">static</span> <a class="code" href="structclient__t.html">client_t</a> <a class="code" href="mainloop__good_8c.html#a23">clients</a>[<a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>];    
<a name="l00133"></a><a class="code" href="mainloop__good_8c.html#a24">00133</a> <span class="keyword">static</span> <span class="keyword">struct </span>pollfd <a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[<a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>];       
<a name="l00134"></a><a class="code" href="mainloop__good_8c.html#a25">00134</a> <span class="keyword">static</span> <a class="code" href="structalarm__t.html">alarm_t</a>  <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[<a class="code" href="mainloop__good_8c.html#a6">MAXALARMS</a>];      
00136 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<span class="keywordtype">int</span> msg);
00137 
00138 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__glib_8c.html#a35">blocksigpipe</a>(<span class="keywordtype">void</span>);
00139 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a28">initalarms</a>(<span class="keywordtype">void</span>);
00140 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a29">addalarm</a>(alarmhandler_t handler, <span class="keywordtype">long</span> interval);
00141 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a30">checkalarms</a>(<span class="keywordtype">void</span>);
00142 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a31">alarmhandler</a>(<span class="keywordtype">void</span>);
00143 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a32">heartbeat</a>(<span class="keywordtype">void</span>);
00144 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a33">slowheartbeat</a>(<span class="keywordtype">void</span>);
00145 
00146 <span class="keyword">static</span> <span class="keywordtype">int</span>      <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(<span class="keywordtype">int</span> port);
00147 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(<span class="keywordtype">int</span> fd);
00148 
00149 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a36">initclients</a>();
00150 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a37">addclient</a>(<span class="keywordtype">int</span> fd, eventhandler_t read,
00151                           eventhandler_t write, eventhandler_t except);
00152 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a38">delclient</a>(<span class="keywordtype">int</span> i);
00153 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a39">mainloop</a>();
00154 
00155 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a40">closeclient</a>(<span class="keywordtype">int</span> i);
00156 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a41">acceptecho</a>(<span class="keywordtype">int</span> i);
00157 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a42">readecho</a>(<span class="keywordtype">int</span> i);
00158 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a43">writeecho</a>(<span class="keywordtype">int</span> i);
00159 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a44">flowecho</a>(<span class="keywordtype">int</span> i);
00160 
00161 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a45">acceptchargen</a>(<span class="keywordtype">int</span> i);
00162 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a46">writechargen</a>(<span class="keywordtype">int</span> i);
00163 
00169 <span class="keywordtype">void</span>
<a name="l00170"></a><a class="code" href="mainloop__good_8c.html#a26">00170</a> <a class="code" href="mainloop__good_8c.html#a26">message</a>(<span class="keywordtype">int</span> msg)
00171 {
00172     <span class="keywordflow">switch</span> (msg) {
00173     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a6">MSG_HEARTBEAT</a>:
00174         printf(<span class="stringliteral">"H"</span>);
00175         <span class="keywordflow">break</span>;
00176     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a7">MSG_SLOWHEARTBEAT</a>:
00177         printf(<span class="stringliteral">"S"</span>);
00178         <span class="keywordflow">break</span>;
00179     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a8">MSG_MAINLOOP</a>:
00180         <span class="comment">/* printf("M"); */</span>
00181         <span class="keywordflow">break</span>;
00182     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a9">MSG_ACCEPT</a>:
00183         printf(<span class="stringliteral">"A"</span>);
00184         <span class="keywordflow">break</span>;
00185     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a10">MSG_TOOMANY</a>:
00186         printf(<span class="stringliteral">"T"</span>);
00187         <span class="keywordflow">break</span>;
00188     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a11">MSG_CLOSE</a>:
00189         printf(<span class="stringliteral">"C"</span>);
00190         <span class="keywordflow">break</span>;
00191     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a12">MSG_READ</a>:
00192         printf(<span class="stringliteral">"R"</span>);
00193         <span class="keywordflow">break</span>;
00194     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>:
00195         printf(<span class="stringliteral">"W"</span>);
00196         <span class="keywordflow">break</span>;
00197     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a14">MSG_FULL</a>:
00198         printf(<span class="stringliteral">"F"</span>);
00199         <span class="keywordflow">break</span>;
00200     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a15">MSG_EMPTY</a>:
00201         printf(<span class="stringliteral">"E"</span>);
00202         <span class="keywordflow">break</span>;
00203     }
00204     fflush(stdout);
00205 }
00206 
00213 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00214"></a><a class="code" href="mainloop__good_8c.html#a27">00214</a> <a class="code" href="mainloop__glib_8c.html#a35">blocksigpipe</a>()
00215 {
00216     <span class="keyword">struct </span>sigaction act;
00217 
00218     act.sa_handler = SIG_IGN;
00219     sigemptyset(&amp;act.sa_mask);
00220     act.sa_flags = SA_RESTART;
00221     <span class="keywordflow">if</span> (sigaction(SIGPIPE, &amp;act, NULL) == -1) {
00222         perror(<span class="stringliteral">"sigaction(SIGPIPE, &lt;ignore&gt;)"</span>);
00223         exit(EXIT_FAILURE);
00224     }
00225 }
00226 
00234 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00235"></a><a class="code" href="mainloop__good_8c.html#a28">00235</a> <a class="code" href="mainloop__good_8c.html#a28">initalarms</a>()
00236 {
00237     <span class="keyword">struct </span>sigaction act;
00238     <span class="keywordtype">int</span>             i;
00239 
00240     act.sa_handler = <a class="code" href="mainloop__good_8c.html#a31">alarmhandler</a>;
00241     sigemptyset(&amp;act.sa_mask);
00242     act.sa_flags = 0;           <span class="comment">/* no SIG_RESTART! */</span>
00243     <span class="keywordflow">if</span> (sigaction(SIGALRM, &amp;act, NULL) == -1) {
00244         perror(<span class="stringliteral">"sigaction(SIGPIPE, &lt;ignore&gt;)"</span>);
00245         exit(EXIT_FAILURE);
00246     }
00247     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__good_8c.html#a6">MAXALARMS</a>; i++) {
00248         <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o0">handler</a> = NULL;
00249     }
00250     alarm(0);                   <span class="comment">/* cancel any previously made alarm request */</span>
00251 }
00252 
00262 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00263"></a><a class="code" href="mainloop__good_8c.html#a29">00263</a> <a class="code" href="mainloop__good_8c.html#a29">addalarm</a>(alarmhandler_t handler, <span class="keywordtype">long</span> interval)
00264 {
00265     <span class="keyword">struct </span>timeval  now;
00266     <span class="keywordtype">int</span>             i;
00267 
00268     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__good_8c.html#a6">MAXALARMS</a>; i++) {
00269         <span class="keywordflow">if</span> (<a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o0">handler</a> == NULL) {
00270             gettimeofday(&amp;now, NULL);
00271             <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o0">handler</a> = handler;
00272             <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o1">interval</a> = interval;
00273             <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o2">nexttime</a> = now.tv_sec + interval;
00274             <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o3">flag</a> = 0;
00275             <a class="code" href="mainloop__good_8c.html#a31">alarmhandler</a>();
00276             <span class="keywordflow">return</span>;
00277         }
00278     }
00279 }
00280 
00284 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00285"></a><a class="code" href="mainloop__good_8c.html#a30">00285</a> <a class="code" href="mainloop__good_8c.html#a30">checkalarms</a>(<span class="keywordtype">void</span>)
00286 {
00287     <span class="keywordtype">int</span>             i;
00288 
00289     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__good_8c.html#a6">MAXALARMS</a>; i++) {
00290         <span class="keywordflow">if</span> (<a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o3">flag</a>) {
00291             (*<a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o0">handler</a>) ();
00292             <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o3">flag</a> = 0;
00293         }
00294     }
00295 }
00296 
00306 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00307"></a><a class="code" href="mainloop__good_8c.html#a31">00307</a> <a class="code" href="mainloop__good_8c.html#a31">alarmhandler</a>(<span class="keywordtype">void</span>)
00308 {
00309     <span class="keyword">struct </span>timeval  now;
00310     <span class="keywordtype">long</span>            nextalarm;
00311     <span class="keywordtype">int</span>             i;
00312 
00313     gettimeofday(&amp;now, NULL);
00314 
00315     nextalarm = 65536;
00316     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__good_8c.html#a6">MAXALARMS</a>; i++) {
00317         <span class="keywordflow">if</span> (<a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o0">handler</a> != NULL) {
00318             <span class="keywordflow">if</span> (<a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o2">nexttime</a> &lt;= now.tv_sec) {
00319                 <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o3">flag</a> = 1;
00320                 <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o2">nexttime</a> += <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].<a class="code" href="structalarm__t.html#o1">interval</a>;
00321             }
00322             nextalarm =
00323                 <a class="code" href="mainloop__bad_8c.html#a16">MIN</a>(nextalarm,
00324                     <a class="code" href="mainloop__bad_8c.html#a17">MAX</a>(1,
00325                         (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) <a class="code" href="mainloop__good_8c.html#a25">alarms</a>[i].nexttime - now.tv_sec));
00326         }
00327     }
00328     alarm((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) nextalarm);
00329 }
00330 
00334 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00335"></a><a class="code" href="mainloop__good_8c.html#a32">00335</a> <a class="code" href="mainloop__good_8c.html#a32">heartbeat</a>()
00336 {
00337     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a6">MSG_HEARTBEAT</a>);
00338 }
00339 
00343 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00344"></a><a class="code" href="mainloop__good_8c.html#a33">00344</a> <a class="code" href="mainloop__good_8c.html#a33">slowheartbeat</a>()
00345 {
00346     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a7">MSG_SLOWHEARTBEAT</a>);
00347 }
00348 
00358 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00359"></a><a class="code" href="mainloop__good_8c.html#a34">00359</a> <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(<span class="keywordtype">int</span> port)
00360 {
00361     <span class="keywordtype">int</span>             serverfd;
00362     <span class="keyword">struct </span>sockaddr_in sain;
00363     <span class="keywordtype">int</span>             one;
00364 
00365     <span class="comment">/* set up tcp socket for listening */</span>
00366     sain.sin_family = AF_INET;
00367     sain.sin_port = htons(port);
00368     sain.sin_addr.s_addr = INADDR_ANY;
00369     <span class="keywordflow">if</span> ((serverfd = socket(AF_INET, SOCK_STREAM, 0)) == -1) {
00370         perror(<span class="stringliteral">"socket(AF_INET, SOCK_STREAM, 0)"</span>);
00371         exit(EXIT_FAILURE);
00372     }
00373     one = 1;
00374     <span class="keywordflow">if</span> (setsockopt
00375         (serverfd, SOL_SOCKET, SO_REUSEADDR, &amp;one,
00376          (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(one)) == -1) {
00377         perror(<span class="stringliteral">"setsockopt(SO_REUSEADDR)"</span>);
00378         exit(EXIT_FAILURE);
00379     }
00380     <span class="keywordflow">if</span> (bind
00381         (serverfd, (<span class="keyword">struct </span>sockaddr *) &amp;sain, <span class="keyword">sizeof</span>(<span class="keyword">struct </span>sockaddr_in))
00382         == -1) {
00383         perror(<span class="stringliteral">"bind()"</span>);
00384         exit(EXIT_FAILURE);
00385     }
00386     <span class="keywordflow">if</span> (listen(serverfd, 5) == -1) {
00387         perror(<span class="stringliteral">"listen()"</span>);
00388         exit(EXIT_FAILURE);
00389     }
00390     <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(serverfd);
00391 
00392     printf(<span class="stringliteral">"listening on port %d\n"</span>, port);
00393 
00394     <span class="keywordflow">return</span> serverfd;
00395 }
00396 
00405 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00406"></a><a class="code" href="mainloop__good_8c.html#a35">00406</a> <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(<span class="keywordtype">int</span> fd)
00407 {
00408     <span class="keywordtype">int</span>             flag;
00409 
00410     flag = fcntl(fd, F_GETFL);
00411     fcntl(fd, F_GETFL, flag | O_NONBLOCK);
00412 }
00413 
00417 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00418"></a><a class="code" href="mainloop__good_8c.html#a36">00418</a> <a class="code" href="mainloop__good_8c.html#a36">initclients</a>()
00419 {
00420     <span class="keywordtype">int</span>             i;
00421 
00422     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00423         <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o0">fd</a> = -1;
00424     }
00425     <a class="code" href="mainloop__good_8c.html#a22">npollfd</a> = 0;
00426 }
00427 
00436 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00437"></a><a class="code" href="mainloop__good_8c.html#a37">00437</a> <a class="code" href="mainloop__good_8c.html#a37">addclient</a>(<span class="keywordtype">int</span> fd, eventhandler_t read, eventhandler_t write,
00438           eventhandler_t except)
00439 {
00440     <span class="keywordflow">if</span> (<a class="code" href="mainloop__good_8c.html#a22">npollfd</a> &gt;= (<a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a> - 1)) {
00441         close(fd);
00442         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a10">MSG_TOOMANY</a>);
00443         <span class="keywordflow">return</span>;
00444     }
00445     <a class="code" href="mainloop__good_8c.html#a23">clients</a>[<a class="code" href="mainloop__good_8c.html#a22">npollfd</a>].<a class="code" href="structclient__t.html#o0">fd</a> = fd;
00446     <a class="code" href="mainloop__good_8c.html#a23">clients</a>[<a class="code" href="mainloop__good_8c.html#a22">npollfd</a>].<a class="code" href="structclient__t.html#o1">read</a> = read;
00447     <a class="code" href="mainloop__good_8c.html#a23">clients</a>[<a class="code" href="mainloop__good_8c.html#a22">npollfd</a>].<a class="code" href="structclient__t.html#o2">write</a> = write;
00448     <a class="code" href="mainloop__good_8c.html#a23">clients</a>[<a class="code" href="mainloop__good_8c.html#a22">npollfd</a>].<a class="code" href="structclient__t.html#o3">except</a> = except;
00449     <a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[<a class="code" href="mainloop__good_8c.html#a22">npollfd</a>].fd = fd;
00450     <a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[<a class="code" href="mainloop__good_8c.html#a22">npollfd</a>].events = 0;
00451     <span class="keywordflow">if</span> (read) {
00452         <a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[<a class="code" href="mainloop__good_8c.html#a22">npollfd</a>].events |= POLLIN;
00453     }
00454     <span class="keywordflow">if</span> (write) {
00455         <a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[<a class="code" href="mainloop__good_8c.html#a22">npollfd</a>].events |= POLLOUT;
00456     }
00457     <a class="code" href="mainloop__good_8c.html#a22">npollfd</a>++;
00458 }
00459 
00465 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00466"></a><a class="code" href="mainloop__good_8c.html#a38">00466</a> <a class="code" href="mainloop__good_8c.html#a38">delclient</a>(<span class="keywordtype">int</span> i)
00467 {
00468     <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o0">fd</a> = -1;
00469     <span class="keywordflow">if</span> (i != <a class="code" href="mainloop__good_8c.html#a22">npollfd</a>) {
00470         <span class="comment">/* just copy the whole thing including the buffer... */</span>
00471         memcpy(&amp;<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i], &amp;<a class="code" href="mainloop__good_8c.html#a23">clients</a>[<a class="code" href="mainloop__good_8c.html#a22">npollfd</a>], <span class="keyword">sizeof</span>(<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i]));
00472         <a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[i] = <a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[<a class="code" href="mainloop__good_8c.html#a22">npollfd</a>];
00473         <a class="code" href="mainloop__good_8c.html#a22">npollfd</a>--;
00474     }
00475 }
00476 
00480 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00481"></a><a class="code" href="mainloop__good_8c.html#a39">00481</a> <a class="code" href="mainloop__good_8c.html#a39">mainloop</a>()
00482 {
00483     <span class="keywordtype">int</span>             i;
00484 
00485     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a8">MSG_MAINLOOP</a>);
00486     i = poll(<a class="code" href="mainloop__good_8c.html#a24">pollfds</a>, <a class="code" href="mainloop__good_8c.html#a22">npollfd</a>, -1);
00487 
00488     <span class="comment">/* check for alarm handlers to be executed */</span>
00489     <a class="code" href="mainloop__good_8c.html#a30">checkalarms</a>();
00490 
00491     <span class="keywordflow">if</span> (i == -1) {
00492         <span class="keywordflow">if</span> ((errno != EAGAIN) &amp;&amp; (errno != EINTR)) {
00493             perror(<span class="stringliteral">"poll()"</span>);
00494             exit(EXIT_FAILURE);
00495         }
00496         <span class="keywordflow">return</span>;
00497     }
00498 
00499     <span class="comment">/* </span>
00500 <span class="comment">     * handle i/o events. work off exceptions first. then read (try to fill</span>
00501 <span class="comment">     * buffer) and write (try to empty buffer)</span>
00502 <span class="comment">     */</span>
00503     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="mainloop__good_8c.html#a22">npollfd</a>; i++) {
00504         <span class="keywordflow">if</span> ((<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o3">except</a>)
00505             &amp;&amp; (<a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[i].revents &amp; (POLLERR | POLLHUP | POLLNVAL))) {
00506             (*<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o3">except</a>) (i);
00507             <span class="keywordflow">continue</span>;
00508         }
00509         <span class="keywordflow">if</span> ((<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o1">read</a>) &amp;&amp; (<a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[i].revents &amp; POLLIN)) {
00510             (*<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o1">read</a>) (i);
00511         }
00512         <span class="keywordflow">if</span> ((<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o2">write</a>) &amp;&amp; (<a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[i].revents &amp; POLLOUT)) {
00513             (*<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o2">write</a>) (i);
00514         }
00515     }
00516 }
00517 
00523 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00524"></a><a class="code" href="mainloop__good_8c.html#a41">00524</a> <a class="code" href="mainloop__good_8c.html#a41">acceptecho</a>(<span class="keywordtype">int</span> i)
00525 {
00526     <span class="keywordtype">int</span>             fd;
00527     socklen_t       t;
00528     <span class="keyword">struct </span>sockaddr_in sain;
00529 
00530     t = <span class="keyword">sizeof</span>(sain);
00531     <span class="keywordflow">if</span> ((fd = accept(<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].fd, (<span class="keywordtype">void</span> *) &amp;sain, &amp;t)) == -1) {
00532         <span class="keywordflow">if</span> (errno == EWOULDBLOCK) {
00533             <span class="keywordflow">return</span>;
00534         }
00535         perror(<span class="stringliteral">"accept(ECHO)"</span>);
00536         exit(EXIT_FAILURE);
00537     }
00538     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a9">MSG_ACCEPT</a>);
00539     <a class="code" href="mainloop__good_8c.html#a37">addclient</a>(fd, &amp;<a class="code" href="mainloop__good_8c.html#a42">readecho</a>, &amp;<a class="code" href="mainloop__good_8c.html#a43">writeecho</a>, &amp;<a class="code" href="mainloop__good_8c.html#a40">closeclient</a>);
00540 }
00541 
00550 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00551"></a><a class="code" href="mainloop__good_8c.html#a42">00551</a> <a class="code" href="mainloop__good_8c.html#a42">readecho</a>(<span class="keywordtype">int</span> i)
00552 {
00553     ssize_t         nread;
00554 
00555     <span class="keywordflow">if</span> (<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o2">n</a> == <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>) {
00556         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a14">MSG_FULL</a>);
00557         <a class="code" href="mainloop__good_8c.html#a44">flowecho</a>(i);
00558         <span class="keywordflow">return</span>;
00559     }
00560     <span class="keywordflow">if</span> (<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o0">r</a> &gt;= <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o1">w</a>) {
00561         nread =
00562             read(<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].fd, <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].echo.buf + <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o0">r</a>,
00563                  <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a> - <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o0">r</a>);
00564     } <span class="keywordflow">else</span> {
00565         nread =
00566             read(<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].fd, <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].echo.buf + <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o0">r</a>,
00567                  <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o1">w</a> - <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o0">r</a>);
00568     }
00569 
00570     <span class="keywordflow">switch</span> (nread) {
00571     <span class="keywordflow">case</span> -1:
00572         <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00573             perror(<span class="stringliteral">"read()"</span>);
00574             exit(EXIT_FAILURE);
00575         }
00576         <span class="keywordflow">break</span>;
00577     <span class="keywordflow">case</span> 0:
00578         <a class="code" href="mainloop__good_8c.html#a40">closeclient</a>(i);
00579         <span class="keywordflow">return</span>;
00580     <span class="keywordflow">default</span>:
00581         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a12">MSG_READ</a>);
00582         <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o2">n</a> += nread;
00583         <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o0">r</a> += nread;
00584         <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o0">r</a> %= <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>;
00585         <a class="code" href="mainloop__good_8c.html#a44">flowecho</a>(i);
00586     }
00587 }
00588 
00597 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00598"></a><a class="code" href="mainloop__good_8c.html#a43">00598</a> <a class="code" href="mainloop__good_8c.html#a43">writeecho</a>(<span class="keywordtype">int</span> i)
00599 {
00600     ssize_t         nwrite;
00601 
00602     <span class="keywordflow">if</span> (<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o2">n</a> == 0) {
00603         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a15">MSG_EMPTY</a>);
00604         <a class="code" href="mainloop__good_8c.html#a44">flowecho</a>(i);
00605         <span class="keywordflow">return</span>;
00606     }
00607     <span class="keywordflow">if</span> (<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o0">r</a> &gt; <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o1">w</a>) {
00608         nwrite =
00609             write(<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].fd, <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].echo.buf + <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o1">w</a>,
00610                   <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o0">r</a> - <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o1">w</a>);
00611     } <span class="keywordflow">else</span> {
00612         nwrite =
00613             write(<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].fd, <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].echo.buf + <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o1">w</a>,
00614                   <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a> - <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o1">w</a>);
00615     }
00616 
00617     <span class="keywordflow">switch</span> (nwrite) {
00618     <span class="keywordflow">case</span> -1:
00619         <span class="keywordflow">if</span> (errno == EPIPE) {
00620             <a class="code" href="mainloop__good_8c.html#a40">closeclient</a>(i);
00621         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00622             perror(<span class="stringliteral">"write()"</span>);
00623             exit(EXIT_FAILURE);
00624         }
00625         <span class="keywordflow">break</span>;
00626     <span class="keywordflow">case</span> 0:
00627         <span class="keywordflow">break</span>;
00628     <span class="keywordflow">default</span>:
00629         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>);
00630         <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o2">n</a> -= nwrite;
00631         <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o1">w</a> += nwrite;
00632         <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o1">w</a> %= <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>;
00633         <a class="code" href="mainloop__good_8c.html#a44">flowecho</a>(i);
00634     }
00635 }
00636 
00645 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00646"></a><a class="code" href="mainloop__good_8c.html#a44">00646</a> <a class="code" href="mainloop__good_8c.html#a44">flowecho</a>(<span class="keywordtype">int</span> i)
00647 {
00648     <span class="keywordflow">switch</span> (<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o4">echo</a>.<a class="code" href="structecho__client__t.html#o2">n</a>) {
00649     <span class="keywordflow">case</span> 0:
00650         <a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[i].events = POLLIN;
00651         <span class="keywordflow">break</span>;
00652     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>:
00653         <a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[i].events = POLLOUT;
00654         <span class="keywordflow">break</span>;
00655     <span class="keywordflow">default</span>:
00656         <a class="code" href="mainloop__good_8c.html#a24">pollfds</a>[i].events = POLLIN | POLLOUT;
00657     }
00658 }
00659 
00665 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00666"></a><a class="code" href="mainloop__good_8c.html#a40">00666</a> <a class="code" href="mainloop__good_8c.html#a40">closeclient</a>(<span class="keywordtype">int</span> i)
00667 {
00668     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a11">MSG_CLOSE</a>);
00669     close(<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].fd);
00670     <a class="code" href="mainloop__good_8c.html#a38">delclient</a>(i);
00671     <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o0">fd</a> = -1;
00672 }
00673 
00679 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00680"></a><a class="code" href="mainloop__good_8c.html#a45">00680</a> <a class="code" href="mainloop__good_8c.html#a45">acceptchargen</a>(<span class="keywordtype">int</span> i)
00681 {
00682     <span class="keywordtype">int</span>             fd;
00683     socklen_t       t;
00684     <span class="keyword">struct </span>sockaddr_in sain;
00685 
00686     t = <span class="keyword">sizeof</span>(sain);
00687     <span class="keywordflow">if</span> ((fd = accept(<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].fd, (<span class="keywordtype">void</span> *) &amp;sain, &amp;t)) == -1) {
00688         <span class="keywordflow">if</span> (errno == EWOULDBLOCK) {
00689             <span class="keywordflow">return</span>;
00690         }
00691         perror(<span class="stringliteral">"accept(CHARGEN)"</span>);
00692         exit(EXIT_FAILURE);
00693     }
00694     <a class="code" href="mainloop__good_8c.html#a37">addclient</a>(fd, NULL, &amp;<a class="code" href="mainloop__good_8c.html#a46">writechargen</a>, &amp;<a class="code" href="mainloop__good_8c.html#a40">closeclient</a>);
00695 }
00696 
00705 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00706"></a><a class="code" href="mainloop__good_8c.html#a46">00706</a> <a class="code" href="mainloop__good_8c.html#a46">writechargen</a>(<span class="keywordtype">int</span> i)
00707 {
00708     ssize_t         nwrite;
00709 
00710     nwrite =
00711         write(<a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].fd, <a class="code" href="mainloop__good_8c.html#a19">chargen_buf</a> + <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].chargen.i,
00712               <span class="keyword">sizeof</span>(<a class="code" href="mainloop__good_8c.html#a19">chargen_buf</a>) - <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o5">chargen</a>.<a class="code" href="structchargen__client__t.html#o0">i</a>);
00713 
00714     <span class="keywordflow">switch</span> (nwrite) {
00715     <span class="keywordflow">case</span> -1:
00716         <span class="keywordflow">if</span> (errno == EPIPE) {
00717             <a class="code" href="mainloop__good_8c.html#a40">closeclient</a>(i);
00718             <span class="keywordflow">return</span>;
00719         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00720             perror(<span class="stringliteral">"write()"</span>);
00721             exit(EXIT_FAILURE);
00722         }
00723         <span class="keywordflow">break</span>;
00724     <span class="keywordflow">case</span> 0:
00725         <span class="keywordflow">break</span>;
00726     <span class="keywordflow">default</span>:
00727         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>);
00728         <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o5">chargen</a>.<a class="code" href="structchargen__client__t.html#o0">i</a> += nwrite;
00729         <a class="code" href="mainloop__good_8c.html#a23">clients</a>[i].<a class="code" href="structclient__t.html#o5">chargen</a>.<a class="code" href="structchargen__client__t.html#o0">i</a> %= <span class="keyword">sizeof</span>(<a class="code" href="mainloop__good_8c.html#a19">chargen_buf</a>);
00730     }
00731 }
00732 
00733 <span class="keywordtype">int</span>
<a name="l00734"></a><a class="code" href="mainloop__good_8c.html#a47">00734</a> <a class="code" href="mainloop__bad_8c.html#a26">main</a>()
00735 {
00736     printf(<span class="stringliteral">"example: better main loop\n"</span>);
00737 
00738     <a class="code" href="mainloop__glib_8c.html#a35">blocksigpipe</a>();
00739 
00740     <a class="code" href="mainloop__good_8c.html#a36">initclients</a>();
00741     <a class="code" href="mainloop__good_8c.html#a37">addclient</a>(<a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(<a class="code" href="mainloop__bad_8c.html#a0">PORT_ECHO</a>), &amp;<a class="code" href="mainloop__good_8c.html#a41">acceptecho</a>, NULL, NULL);
00742     <a class="code" href="mainloop__good_8c.html#a37">addclient</a>(<a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(<a class="code" href="mainloop__bad_8c.html#a1">PORT_CHARGEN</a>), &amp;<a class="code" href="mainloop__good_8c.html#a45">acceptchargen</a>, NULL, NULL);
00743     <a class="code" href="mainloop__good_8c.html#a28">initalarms</a>();
00744     <a class="code" href="mainloop__good_8c.html#a29">addalarm</a>(<a class="code" href="mainloop__good_8c.html#a32">heartbeat</a>, <a class="code" href="mainloop__bad_8c.html#a2">HEARTBEAT_INTERVAL</a>);
00745     <a class="code" href="mainloop__good_8c.html#a29">addalarm</a>(<a class="code" href="mainloop__good_8c.html#a33">slowheartbeat</a>, <a class="code" href="mainloop__bad_8c.html#a3">SLOWHEARTBEAT_INTERVAL</a>);
00746     printf(<span class="stringliteral">"heartbeat every %d seconds\n"</span>, <a class="code" href="mainloop__bad_8c.html#a2">HEARTBEAT_INTERVAL</a>);
00747     printf(<span class="stringliteral">"slow heartbeat every %d seconds\n"</span>, <a class="code" href="mainloop__bad_8c.html#a3">SLOWHEARTBEAT_INTERVAL</a>);
00748 
00749     <span class="comment">/* main loop */</span>
00750     <span class="keywordflow">while</span> (1) {
00751         <a class="code" href="mainloop__good_8c.html#a39">mainloop</a>();
00752     }
00753     <span class="comment">/* notreached */</span>
00754 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 19 16:02:06 2004 for mainloop by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
