<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mainloop: mainloop_bad.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>mainloop_bad.c</h1><a href="mainloop__bad_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00019 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00020 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00021 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00022 <span class="preprocessor">#include &lt;string.h&gt;</span>
00023 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00024 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00025 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00026 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00027 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00028 
<a name="l00030"></a><a class="code" href="mainloop__bad_8c.html#a0">00030</a> <span class="preprocessor">#define PORT_ECHO 5005</span>
00031 <span class="preprocessor"></span>
<a name="l00033"></a><a class="code" href="mainloop__bad_8c.html#a1">00033</a> <span class="preprocessor">#define PORT_CHARGEN 5006</span>
00034 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="mainloop__bad_8c.html#a2">00036</a> <span class="preprocessor">#define HEARTBEAT_INTERVAL 2</span>
00037 <span class="preprocessor"></span>
<a name="l00039"></a><a class="code" href="mainloop__bad_8c.html#a3">00039</a> <span class="preprocessor">#define SLOWHEARTBEAT_INTERVAL 15</span>
00040 <span class="preprocessor"></span>
<a name="l00042"></a><a class="code" href="mainloop__bad_8c.html#a4">00042</a> <span class="preprocessor">#define BUFSIZE 16</span>
00043 <span class="preprocessor"></span>
<a name="l00045"></a><a class="code" href="mainloop__bad_8c.html#a5">00045</a> <span class="preprocessor">#define MAXCLIENTS 4</span>
00046 <span class="preprocessor"></span>
<a name="l00047"></a><a class="code" href="mainloop__bad_8c.html#a6">00047</a> <span class="preprocessor">#define MSG_HEARTBEAT 0</span>
<a name="l00048"></a><a class="code" href="mainloop__bad_8c.html#a7">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_SLOWHEARTBEAT 1</span>
<a name="l00049"></a><a class="code" href="mainloop__bad_8c.html#a8">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_MAINLOOP 2</span>
<a name="l00050"></a><a class="code" href="mainloop__bad_8c.html#a9">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_ACCEPT 3</span>
<a name="l00051"></a><a class="code" href="mainloop__bad_8c.html#a10">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_TOOMANY 4</span>
<a name="l00052"></a><a class="code" href="mainloop__bad_8c.html#a11">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_CLOSE 5</span>
<a name="l00053"></a><a class="code" href="mainloop__bad_8c.html#a12">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_READ 6</span>
<a name="l00054"></a><a class="code" href="mainloop__bad_8c.html#a13">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_WRITE 7</span>
<a name="l00055"></a><a class="code" href="mainloop__bad_8c.html#a14">00055</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_FULL 8</span>
<a name="l00056"></a><a class="code" href="mainloop__bad_8c.html#a15">00056</a> <span class="preprocessor"></span><span class="preprocessor">#define MSG_EMPTY 9</span>
00057 <span class="preprocessor"></span>
<a name="l00058"></a><a class="code" href="mainloop__bad_8c.html#a16">00058</a> <span class="preprocessor">#define MIN(a, b)       ((a)&lt;(b)?(a):(b))</span>
<a name="l00059"></a><a class="code" href="mainloop__bad_8c.html#a17">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX(a, b)       ((a)&gt;(b)?(a):(b))</span>
00060 <span class="preprocessor"></span>
<a name="l00062"></a><a class="code" href="mainloop__bad_8c.html#a18">00062</a> <span class="keyword">static</span> <span class="keywordtype">char</span>     <a class="code" href="mainloop__bad_8c.html#a18">chargen_buf</a>[] = <span class="stringliteral">"0123456789abcdefghijklmnopqrstuv"</span>;
00063 
<a name="l00067"></a><a class="code" href="structechoclient__t.html">00067</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00068"></a><a class="code" href="structechoclient__t.html#o0">00068</a>     <span class="keywordtype">int</span>             fd; 
<a name="l00069"></a><a class="code" href="structechoclient__t.html#o1">00069</a>     <span class="keywordtype">int</span>             r;  
<a name="l00070"></a><a class="code" href="structechoclient__t.html#o2">00070</a>     <span class="keywordtype">int</span>             w;  
<a name="l00071"></a><a class="code" href="structechoclient__t.html#o3">00071</a>     <span class="keywordtype">int</span>             n;  
<a name="l00072"></a><a class="code" href="structechoclient__t.html#o4">00072</a>     <span class="keywordtype">char</span>            buf[<a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>];       
00073 } <a class="code" href="structechoclient__t.html">echoclient_t</a>;
00074 
<a name="l00075"></a><a class="code" href="structchargenclient__t.html">00075</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00076"></a><a class="code" href="structchargenclient__t.html#o0">00076</a>     <span class="keywordtype">int</span>             fd; 
<a name="l00077"></a><a class="code" href="structchargenclient__t.html#o1">00077</a>     <span class="keywordtype">int</span>             i;          
00078 } <a class="code" href="structchargenclient__t.html">chargenclient_t</a>;
00079 
00080 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a26">message</a>(<span class="keywordtype">int</span> msg);
00081 <span class="keyword">static</span> <span class="keywordtype">int</span>      <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(<span class="keywordtype">int</span> port);
00082 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(<span class="keywordtype">int</span> fd);
00083 
00084 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__bad_8c.html#a22">sighandler</a>(<span class="keywordtype">int</span> signo);
00085 
00086 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a42">readecho</a>(<a class="code" href="structechoclient__t.html">echoclient_t</a> * client);
00087 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a43">writeecho</a>(<a class="code" href="structechoclient__t.html">echoclient_t</a> * client);
00088 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="mainloop__good_8c.html#a46">writechargen</a>(<a class="code" href="structchargenclient__t.html">chargenclient_t</a> * client);
00089 
00095 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00096"></a><a class="code" href="mainloop__bad_8c.html#a19">00096</a> <a class="code" href="mainloop__good_8c.html#a26">message</a>(<span class="keywordtype">int</span> msg)
00097 {
00098     <span class="keywordflow">switch</span> (msg) {
00099     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a6">MSG_HEARTBEAT</a>:
00100         printf(<span class="stringliteral">"H"</span>);
00101         <span class="keywordflow">break</span>;
00102     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a7">MSG_SLOWHEARTBEAT</a>:
00103         printf(<span class="stringliteral">"S"</span>);
00104         <span class="keywordflow">break</span>;
00105     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a8">MSG_MAINLOOP</a>:
00106         <span class="comment">/* printf("M"); */</span>
00107         <span class="keywordflow">break</span>;
00108     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a9">MSG_ACCEPT</a>:
00109         printf(<span class="stringliteral">"A"</span>);
00110         <span class="keywordflow">break</span>;
00111     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a10">MSG_TOOMANY</a>:
00112         printf(<span class="stringliteral">"T"</span>);
00113         <span class="keywordflow">break</span>;
00114     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a11">MSG_CLOSE</a>:
00115         printf(<span class="stringliteral">"C"</span>);
00116         <span class="keywordflow">break</span>;
00117     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a12">MSG_READ</a>:
00118         printf(<span class="stringliteral">"R"</span>);
00119         <span class="keywordflow">break</span>;
00120     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>:
00121         printf(<span class="stringliteral">"W"</span>);
00122         <span class="keywordflow">break</span>;
00123     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a14">MSG_FULL</a>:
00124         printf(<span class="stringliteral">"F"</span>);
00125         <span class="keywordflow">break</span>;
00126     <span class="keywordflow">case</span> <a class="code" href="mainloop__bad_8c.html#a15">MSG_EMPTY</a>:
00127         printf(<span class="stringliteral">"E"</span>);
00128         <span class="keywordflow">break</span>;
00129     }
00130     fflush(stdout);
00131 }
00132 
00138 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00139"></a><a class="code" href="mainloop__bad_8c.html#a22">00139</a> <a class="code" href="mainloop__bad_8c.html#a22">sighandler</a>(<span class="keywordtype">int</span> signo)
00140 {
00141     <span class="keyword">struct </span>timeval  now;
00142     <span class="keyword">static</span> time_t   time_heartbeat, time_slowheartbeat;
00143     <span class="keywordtype">int</span>             nextalarm;
00144 
00145     <span class="keywordflow">switch</span> (signo) {
00146     <span class="keywordflow">case</span> SIGALRM:
00147         <span class="comment">/* </span>
00148 <span class="comment">         * (re)install signal handler and set new alarm</span>
00149 <span class="comment">         * there is a possible race condition, but for alarm()/SIGALRM this is not a real concern</span>
00150 <span class="comment">         */</span>
00151         <span class="keywordflow">if</span> (signal(SIGALRM, &amp;<a class="code" href="mainloop__bad_8c.html#a22">sighandler</a>) == SIG_ERR) {
00152             perror(<span class="stringliteral">"signal(SIGALRM)"</span>);
00153             exit(EXIT_FAILURE);
00154         }
00155         gettimeofday(&amp;now, NULL);
00156         <span class="keywordflow">if</span> (time_heartbeat == 0) {
00157             time_heartbeat = now.tv_sec + <a class="code" href="mainloop__bad_8c.html#a2">HEARTBEAT_INTERVAL</a>;
00158             time_slowheartbeat = now.tv_sec + <a class="code" href="mainloop__bad_8c.html#a3">SLOWHEARTBEAT_INTERVAL</a>;
00159         }
00160         <span class="keywordflow">if</span> (time_heartbeat &lt;= now.tv_sec) {
00161             time_heartbeat += <a class="code" href="mainloop__bad_8c.html#a2">HEARTBEAT_INTERVAL</a>;
00162             <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a6">MSG_HEARTBEAT</a>);
00163         }
00164         <span class="keywordflow">if</span> (time_slowheartbeat &lt;= now.tv_sec) {
00165             time_slowheartbeat += <a class="code" href="mainloop__bad_8c.html#a3">SLOWHEARTBEAT_INTERVAL</a>;
00166             <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a7">MSG_SLOWHEARTBEAT</a>);
00167         }
00168 
00169         nextalarm =
00170             <a class="code" href="mainloop__bad_8c.html#a17">MAX</a>(1, <a class="code" href="mainloop__bad_8c.html#a16">MIN</a>(time_heartbeat, time_slowheartbeat) - now.tv_sec);
00171 
00172         <span class="keywordflow">if</span> (alarm(nextalarm) == -1) {
00173             perror(<span class="stringliteral">"alarm()"</span>);
00174             exit(EXIT_FAILURE);
00175         }
00176         <span class="keywordflow">break</span>;
00177     <span class="keywordflow">default</span>:
00178         <span class="comment">/* ignore everything */</span>
00179         <span class="keywordflow">break</span>;
00180     }
00181 }
00182 
00192 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00193"></a><a class="code" href="mainloop__bad_8c.html#a20">00193</a> <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(<span class="keywordtype">int</span> port)
00194 {
00195     <span class="keywordtype">int</span>             serverfd;
00196     <span class="keyword">struct </span>sockaddr_in sain;
00197     <span class="keywordtype">int</span>             one;
00198 
00199     <span class="comment">/* set up tcp socket for listening */</span>
00200     sain.sin_family = AF_INET;
00201     sain.sin_port = htons(port);
00202     sain.sin_addr.s_addr = INADDR_ANY;
00203     <span class="keywordflow">if</span> ((serverfd = socket(AF_INET, SOCK_STREAM, 0)) == -1) {
00204         perror(<span class="stringliteral">"socket(AF_INET, SOCK_STREAM, 0)"</span>);
00205         exit(EXIT_FAILURE);
00206     }
00207     one = 1;
00208     <span class="keywordflow">if</span> (setsockopt
00209         (serverfd, SOL_SOCKET, SO_REUSEADDR, &amp;one,
00210          (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(one)) == -1) {
00211         perror(<span class="stringliteral">"setsockopt(SO_REUSEADDR)"</span>);
00212         exit(EXIT_FAILURE);
00213     }
00214     <span class="keywordflow">if</span> (bind
00215         (serverfd, (<span class="keyword">struct </span>sockaddr *) &amp;sain,
00216          <span class="keyword">sizeof</span>(<span class="keyword">struct </span>sockaddr_in)) == -1) {
00217         perror(<span class="stringliteral">"bind()"</span>);
00218         exit(EXIT_FAILURE);
00219     }
00220     <span class="keywordflow">if</span> (listen(serverfd, 5) == -1) {
00221         perror(<span class="stringliteral">"listen()"</span>);
00222         exit(EXIT_FAILURE);
00223     }
00224     <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(serverfd);
00225 
00226     printf(<span class="stringliteral">"listening on port %d\n"</span>, port);
00227 
00228     <span class="keywordflow">return</span> serverfd;
00229 }
00230 
00239 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00240"></a><a class="code" href="mainloop__bad_8c.html#a21">00240</a> <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(<span class="keywordtype">int</span> fd)
00241 {
00242     <span class="keywordtype">int</span>             flag;
00243 
00244     flag = fcntl(fd, F_GETFL);
00245     fcntl(fd, F_GETFL, flag | O_NONBLOCK);
00246 }
00247 
00256 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00257"></a><a class="code" href="mainloop__bad_8c.html#a23">00257</a> <a class="code" href="mainloop__good_8c.html#a42">readecho</a>(<a class="code" href="structechoclient__t.html">echoclient_t</a> * client)
00258 {
00259     <span class="keywordtype">int</span>             nread;
00260 
00261     <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structechoclient__t.html#o3">n</a> == <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>) {
00262         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a14">MSG_FULL</a>);
00263         <span class="keywordflow">return</span>;
00264     }
00265 
00266     <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a> &gt;= client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>) {
00267         nread =
00268             read(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>, client-&gt;<a class="code" href="structechoclient__t.html#o4">buf</a> + client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a>, <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a> - client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a>);
00269     } <span class="keywordflow">else</span> {
00270         nread =
00271             read(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>, client-&gt;<a class="code" href="structechoclient__t.html#o4">buf</a> + client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a>,
00272                  client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a> - client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a>);
00273     }
00274 
00275     <span class="keywordflow">switch</span> (nread) {
00276     <span class="keywordflow">case</span> 0:
00277         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a11">MSG_CLOSE</a>);
00278         close(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>);
00279         client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a> = -1;
00280         <span class="keywordflow">break</span>;
00281     <span class="keywordflow">case</span> -1:
00282         <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00283             perror(<span class="stringliteral">"read()"</span>);
00284             exit(EXIT_FAILURE);
00285         }
00286         <span class="keywordflow">break</span>;
00287     <span class="keywordflow">default</span>:
00288         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a12">MSG_READ</a>);
00289         client-&gt;<a class="code" href="structechoclient__t.html#o3">n</a> += nread;
00290         client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a> += nread;
00291         client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a> %= <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>;
00292     }
00293 }
00294 
00303 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00304"></a><a class="code" href="mainloop__bad_8c.html#a24">00304</a> <a class="code" href="mainloop__good_8c.html#a43">writeecho</a>(<a class="code" href="structechoclient__t.html">echoclient_t</a> * client)
00305 {
00306     <span class="keywordtype">int</span>             nwrite;
00307 
00308     <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structechoclient__t.html#o3">n</a> == 0) {
00309         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a15">MSG_EMPTY</a>);
00310         <span class="keywordflow">return</span>;
00311     }
00312 
00313     <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a> &gt; client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>) {
00314         nwrite =
00315             write(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>, client-&gt;<a class="code" href="structechoclient__t.html#o4">buf</a> + client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>,
00316                   client-&gt;<a class="code" href="structechoclient__t.html#o1">r</a> - client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>);
00317     } <span class="keywordflow">else</span> {
00318         nwrite =
00319             write(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>, client-&gt;<a class="code" href="structechoclient__t.html#o4">buf</a> + client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>,
00320                   <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a> - client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a>);
00321     }
00322 
00323     <span class="keywordflow">switch</span> (nwrite) {
00324     <span class="keywordflow">case</span> -1:
00325         <span class="keywordflow">if</span> (errno == EPIPE) {
00326             <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a11">MSG_CLOSE</a>);
00327             close(client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a>);
00328             client-&gt;<a class="code" href="structechoclient__t.html#o0">fd</a> = -1;
00329         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00330             perror(<span class="stringliteral">"write()"</span>);
00331             exit(EXIT_FAILURE);
00332         }
00333         <span class="keywordflow">break</span>;
00334     <span class="keywordflow">case</span> 0:
00335         <span class="keywordflow">break</span>;
00336     <span class="keywordflow">default</span>:
00337         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>);
00338         client-&gt;<a class="code" href="structechoclient__t.html#o3">n</a> -= nwrite;
00339         client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a> += nwrite;
00340         client-&gt;<a class="code" href="structechoclient__t.html#o2">w</a> %= <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>;
00341     }
00342 }
00343 
00349 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00350"></a><a class="code" href="mainloop__bad_8c.html#a25">00350</a> <a class="code" href="mainloop__good_8c.html#a46">writechargen</a>(<a class="code" href="structchargenclient__t.html">chargenclient_t</a> * client)
00351 {
00352     <span class="keywordtype">int</span>             nwrite;
00353 
00354     nwrite =
00355         write(client-&gt;<a class="code" href="structchargenclient__t.html#o0">fd</a>, <a class="code" href="mainloop__bad_8c.html#a18">chargen_buf</a> + client-&gt;<a class="code" href="structchargenclient__t.html#o1">i</a>,
00356               <span class="keyword">sizeof</span>(<a class="code" href="mainloop__bad_8c.html#a18">chargen_buf</a>) - client-&gt;<a class="code" href="structchargenclient__t.html#o1">i</a>);
00357 
00358     <span class="keywordflow">switch</span> (nwrite) {
00359     <span class="keywordflow">case</span> -1:
00360         <span class="keywordflow">if</span> (errno == EPIPE) {
00361             <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a11">MSG_CLOSE</a>);
00362             close(client-&gt;<a class="code" href="structchargenclient__t.html#o0">fd</a>);
00363             client-&gt;<a class="code" href="structchargenclient__t.html#o0">fd</a> = -1;
00364         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((errno != EINTR) &amp;&amp; (errno != EWOULDBLOCK)) {
00365             perror(<span class="stringliteral">"write()"</span>);
00366             exit(EXIT_FAILURE);
00367         }
00368         <span class="keywordflow">break</span>;
00369     <span class="keywordflow">case</span> 0:
00370         <span class="keywordflow">break</span>;
00371     <span class="keywordflow">default</span>:
00372         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a13">MSG_WRITE</a>);
00373         client-&gt;<a class="code" href="structchargenclient__t.html#o1">i</a> += nwrite;
00374         client-&gt;<a class="code" href="structchargenclient__t.html#o1">i</a> %= <span class="keyword">sizeof</span>(<a class="code" href="mainloop__bad_8c.html#a18">chargen_buf</a>);
00375     }
00376 }
00377 
00378 <span class="keywordtype">int</span>
<a name="l00379"></a><a class="code" href="mainloop__bad_8c.html#a26">00379</a> <a class="code" href="mainloop__bad_8c.html#a26">main</a>()
00380 {
00381     <span class="keywordtype">int</span>             echoserverfd;
00382     <span class="keywordtype">int</span>             chargenserverfd;
00383     <a class="code" href="structechoclient__t.html">echoclient_t</a>    echoclients[<a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>];
00384     <a class="code" href="structchargenclient__t.html">chargenclient_t</a> chargenclients[<a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>];
00385     fd_set          rfdset, wfdset;
00386     <span class="keywordtype">int</span>             fdsetmax;
00387     <span class="keywordtype">int</span>             n, i;
00388     size_t          s;
00389     <span class="keyword">struct </span>sockaddr_in sain;
00390 
00391     printf(<span class="stringliteral">"example: bad main loop\n"</span>);
00392 
00393     <span class="comment">/* </span>
00394 <span class="comment">     * ignore SIGPIPE (this occurs whenever a chargen client closes</span>
00395 <span class="comment">     * the connection).</span>
00396 <span class="comment">     */</span>
00397     <span class="keywordflow">if</span> (signal(SIGPIPE, SIG_IGN) == SIG_ERR) {
00398         perror(<span class="stringliteral">"signal(SIGPIPE, SIG_IGN)"</span>);
00399         exit(EXIT_FAILURE);
00400     }
00401 
00402     <span class="comment">/* </span>
00403 <span class="comment">     * install heartbeat. this is done by calling the signal</span>
00404 <span class="comment">     * handler for SIGALRM which then installs itself as a signal</span>
00405 <span class="comment">     * handler and starts the alarm clock.</span>
00406 <span class="comment">     */</span>
00407     printf(<span class="stringliteral">"heartbeat every %d seconds\n"</span>, <a class="code" href="mainloop__bad_8c.html#a2">HEARTBEAT_INTERVAL</a>);
00408     printf(<span class="stringliteral">"slow heartbeat every %d seconds\n"</span>, <a class="code" href="mainloop__bad_8c.html#a3">SLOWHEARTBEAT_INTERVAL</a>);
00409     <a class="code" href="mainloop__bad_8c.html#a22">sighandler</a>(SIGALRM);
00410 
00411     <span class="comment">/* </span>
00412 <span class="comment">     * create server sockets for echo and chargen services</span>
00413 <span class="comment">     */</span>
00414     echoserverfd = <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(<a class="code" href="mainloop__bad_8c.html#a0">PORT_ECHO</a>);
00415     chargenserverfd = <a class="code" href="mainloop__good_8c.html#a34">listensocket</a>(<a class="code" href="mainloop__bad_8c.html#a1">PORT_CHARGEN</a>);
00416 
00417     <span class="comment">/* </span>
00418 <span class="comment">     * reset all client state slots (mark as unused)</span>
00419 <span class="comment">     */</span>
00420     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00421         echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> = -1;
00422         chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> = -1;
00423     }
00424 
00425     <span class="comment">/* </span>
00426 <span class="comment">     * initialize fdsets for select()</span>
00427 <span class="comment">     */</span>
00428     FD_ZERO(&amp;rfdset);
00429     FD_ZERO(&amp;wfdset);
00430     FD_SET(STDIN_FILENO, &amp;rfdset);
00431     FD_SET(echoserverfd, &amp;rfdset);      <span class="comment">/* fd 3 */</span>
00432     FD_SET(chargenserverfd, &amp;rfdset);   <span class="comment">/* fd 4 */</span>
00433     fdsetmax = chargenserverfd; <span class="comment">/* fd 4 */</span>
00434 
00435     <span class="comment">/* </span>
00436 <span class="comment">     * THE main loop</span>
00437 <span class="comment">     * Remeber, this is the bad example. On Solaris, select() is a</span>
00438 <span class="comment">     * (rather clumsy) wrapper around poll(). There is no way to efficiently</span>
00439 <span class="comment">     * emulate select() using poll().</span>
00440 <span class="comment">     */</span>
00441     <span class="keywordflow">while</span> (((n = select(fdsetmax + 1, &amp;rfdset, &amp;wfdset, NULL, NULL)) != -1)
00442            || (errno == EINTR)) {
00443         <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a8">MSG_MAINLOOP</a>);
00444 
00445         <span class="keywordflow">if</span> (n == -1) {
00446             <span class="comment">/* got -1 and errno==EINTR */</span>
00447             <span class="keywordflow">continue</span>;
00448         }
00449 
00450         <span class="comment">/* </span>
00451 <span class="comment">         * check for new echo connections</span>
00452 <span class="comment">         */</span>
00453         <span class="keywordflow">if</span> (FD_ISSET(echoserverfd, &amp;rfdset)) {
00454             <span class="comment">/* find free slot */</span>
00455             <span class="keywordflow">for</span> (i = 0; (i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>) &amp;&amp; (echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> != -1);
00456                  i++);
00457             <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> != -1) {
00458                 <span class="comment">/* no free slots */</span>
00459                 s = <span class="keyword">sizeof</span>(sain);
00460                 i = accept(echoserverfd, (<span class="keyword">struct</span> sockaddr *) &amp;sain, &amp;s);
00461                 close(i);
00462                 <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a10">MSG_TOOMANY</a>);
00463             } <span class="keywordflow">else</span> {
00464                 s = <span class="keyword">sizeof</span>(sain);
00465                 echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> =
00466                     accept(echoserverfd, (<span class="keyword">struct</span> sockaddr *) &amp;sain, &amp;s);
00467                 <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a9">MSG_ACCEPT</a>);
00468                 <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(echoclients[i].fd);
00469                 echoclients[i].<a class="code" href="structechoclient__t.html#o1">r</a> = 0;   <span class="comment">/* start reading from buffer at pos 0 */</span>
00470                 echoclients[i].<a class="code" href="structechoclient__t.html#o2">w</a> = 0;   <span class="comment">/* start writing to buffer at pos 0 */</span>
00471                 echoclients[i].<a class="code" href="structechoclient__t.html#o3">n</a> = 0;   <span class="comment">/* 0 bytes in buffer */</span>
00472             }
00473         }
00474 
00475         <span class="comment">/* </span>
00476 <span class="comment">         * check for new chargen connections</span>
00477 <span class="comment">         */</span>
00478         <span class="keywordflow">if</span> (FD_ISSET(chargenserverfd, &amp;rfdset)) {
00479             <span class="comment">/* find free slot */</span>
00480             <span class="keywordflow">for</span> (i = 0; (i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>) &amp;&amp; (chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> != -1);
00481                  i++);
00482             <span class="keywordflow">if</span> (chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> != -1) {
00483                 <span class="comment">/* no free slots */</span>
00484                 s = <span class="keyword">sizeof</span>(sain);
00485                 i = accept(chargenserverfd, (<span class="keyword">struct</span> sockaddr *) &amp;sain, &amp;s);
00486                 close(i);
00487                 <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a10">MSG_TOOMANY</a>);
00488             } <span class="keywordflow">else</span> {
00489                 s = <span class="keyword">sizeof</span>(sain);
00490                 chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> =
00491                     accept(chargenserverfd, (<span class="keyword">struct</span> sockaddr *) &amp;sain, &amp;s);
00492                 <a class="code" href="mainloop__good_8c.html#a26">message</a>(<a class="code" href="mainloop__bad_8c.html#a9">MSG_ACCEPT</a>);
00493                 <a class="code" href="mainloop__good_8c.html#a35">setnonblock</a>(chargenclients[i].fd);
00494                 chargenclients[i].<a class="code" href="structchargenclient__t.html#o1">i</a> = 0;        <span class="comment">/* start sending from buffer</span>
00495 <span class="comment">                                                 * at pos 0 */</span>
00496             }
00497         }
00498 
00499         <span class="comment">/* </span>
00500 <span class="comment">         * try to read/write data for echo clients</span>
00501 <span class="comment">         */</span>
00502         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00503             <span class="keywordflow">if</span> ((echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> != -1)
00504                 &amp;&amp; (FD_ISSET(echoclients[i].fd, &amp;rfdset))) {
00505                 <a class="code" href="mainloop__good_8c.html#a42">readecho</a>(&amp;echoclients[i]);
00506             }
00507             <span class="keywordflow">if</span> ((echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> != -1)
00508                 &amp;&amp; (FD_ISSET(echoclients[i].fd, &amp;wfdset))) {
00509                 <a class="code" href="mainloop__good_8c.html#a43">writeecho</a>(&amp;echoclients[i]);
00510             }
00511         }
00512 
00513         <span class="comment">/* </span>
00514 <span class="comment">         * try to write data for chargen clients</span>
00515 <span class="comment">         */</span>
00516         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00517             <span class="keywordflow">if</span> ((chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> != -1)
00518                 &amp;&amp; (FD_ISSET(chargenclients[i].fd, &amp;wfdset))) {
00519                 <a class="code" href="mainloop__good_8c.html#a46">writechargen</a>(&amp;chargenclients[i]);
00520             }
00521         }
00522 
00523         <span class="comment">/* </span>
00524 <span class="comment">         * reinitialize fdset</span>
00525 <span class="comment">         */</span>
00526         FD_ZERO(&amp;rfdset);
00527         FD_ZERO(&amp;wfdset);
00528         fdsetmax = chargenserverfd;
00529         FD_SET(echoserverfd, &amp;rfdset);
00530         FD_SET(chargenserverfd, &amp;rfdset);
00531         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00532             <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> &gt;= 0) {
00533                 <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o3">n</a> &lt; <a class="code" href="mainloop__bad_8c.html#a4">BUFSIZE</a>) {
00534                     FD_SET(echoclients[i].fd, &amp;rfdset);
00535                     <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> &gt; fdsetmax) {
00536                         fdsetmax = echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a>;
00537                     }
00538                 }
00539                 <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o3">n</a> &gt; 0) {
00540                     FD_SET(echoclients[i].fd, &amp;wfdset);
00541                     <span class="keywordflow">if</span> (echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a> &gt; fdsetmax) {
00542                         fdsetmax = echoclients[i].<a class="code" href="structechoclient__t.html#o0">fd</a>;
00543                     }
00544                 }
00545             }
00546         }
00547         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mainloop__bad_8c.html#a5">MAXCLIENTS</a>; i++) {
00548             <span class="keywordflow">if</span> (chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> &gt;= 0) {
00549                 FD_SET(chargenclients[i].fd, &amp;wfdset);
00550                 <span class="keywordflow">if</span> (chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a> &gt; fdsetmax) {
00551                     fdsetmax = chargenclients[i].<a class="code" href="structchargenclient__t.html#o0">fd</a>;
00552                 }
00553             }
00554         }
00555     }
00556     <span class="comment">/* notreached */</span>
00557     exit(EXIT_FAILURE);
00558 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 19 16:02:06 2004 for mainloop by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
